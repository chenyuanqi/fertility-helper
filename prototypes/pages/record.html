<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤‡å°å­• - è®°å½•</title>
  <link rel="stylesheet" href="../assets/css/common.css">
  <style>
    /* è®°å½•é¡µé¢ç‰¹æœ‰æ ·å¼ */
    .date-selector {
      background: var(--surface);
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: var(--section-margin);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-small);
    }
    
    .date-display {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .date-nav {
      display: flex;
      gap: 8px;
    }
    
    .date-nav-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: var(--background);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .date-nav-btn:hover {
      background: var(--border);
    }
    
    .record-sections {
      display: flex;
      flex-direction: column;
      gap: var(--section-margin);
    }
    
    .record-section {
      background: var(--surface);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow-small);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .section-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }
    
    .section-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      background: var(--background);
      color: var(--text-secondary);
    }
    
    .section-status.recorded {
      background: var(--success-color);
      color: white;
    }
    
    /* ä½“æ¸©è®°å½•æ ·å¼ */
    .temperature-display {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .temperature-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
    }
    
    .temperature-time {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .temperature-input-btn {
      width: 100%;
      height: 60px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
    }
    
    .temperature-options {
      display: flex;
      gap: 8px;
    }
    
    .option-btn {
      flex: 1;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--border-radius-small);
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .option-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    /* ç»é‡è®°å½•æ ·å¼ */
    .menstruation-section {
      
    }
    
    .flow-description {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
    
    .pad-selector {
      margin: 20px 0;
    }
    
    .pad-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .pad-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 8px;
      border: 2px solid var(--border);
      background: var(--surface);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .pad-option:hover {
      border-color: var(--primary-light);
      background: var(--background);
    }
    
    .pad-option.active {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }
    
    .pad-icon {
      font-size: 18px;
      margin-bottom: 4px;
      line-height: 1.2;
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .pad-label {
      font-size: 12px;
      font-weight: 500;
    }
    
    .pad-description {
      text-align: center;
      font-size: 14px;
      color: var(--text-secondary);
      padding: 8px;
      background: var(--background);
      border-radius: var(--border-radius);
    }
    
    .flow-options {
      display: flex;
      gap: 8px;
    }
    
    /* åŒæˆ¿è®°å½•æ ·å¼ */
    .intimacy-section {
      
    }
    
    .intimacy-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: var(--background);
      border-radius: var(--border-radius);
      margin-bottom: 16px;
      cursor: pointer;
    }
    
    .intimacy-toggle.active {
      background: var(--secondary-color);
      color: white;
    }
    
    .toggle-switch {
      width: 50px;
      height: 30px;
      background: var(--border);
      border-radius: 15px;
      position: relative;
      transition: background-color 0.2s;
    }
    
    .toggle-switch.active {
      background: var(--primary-color);
    }
    
    .toggle-thumb {
      width: 26px;
      height: 26px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
    }
    
    .toggle-switch.active .toggle-thumb {
      transform: translateX(20px);
    }
    
    .intimacy-details {
      display: none;
    }
    
    .intimacy-details.show {
      display: block;
    }
    
    .time-input {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .time-input label {
      font-size: 14px;
      color: var(--text-secondary);
      width: 60px;
    }
    
    /* ä¿å­˜æŒ‰é’® */
    .save-section {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 32px);
      max-width: 343px;
      z-index: 100;
    }
    
    .save-btn {
      width: 100%;
      height: 50px;
      background: linear-gradient(135deg, var(--success-color), #26de81);
      color: white;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-medium);
    }
    
    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-large);
    }
    
    .save-btn:disabled {
      background: var(--text-disabled);
      transform: none;
      box-shadow: var(--shadow-small);
    }
    
    /* é”®ç›˜å¼¹çª— */
    .keyboard-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--surface);
      border-radius: 12px 12px 0 0;
      z-index: 9999;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .keyboard-modal.show {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <div class="page-container">
      <h1 class="page-title">è®°å½•æ•°æ®</h1>
      
      <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
      <div class="date-selector">
        <div class="date-display" id="selectedDate">ä»Šå¤© 1æœˆ25æ—¥</div>
        <div class="date-nav">
          <button class="date-nav-btn" id="prevDay">â†</button>
          <button class="date-nav-btn" id="nextDay">â†’</button>
        </div>
      </div>

      <div class="record-sections">
        <!-- ä½“æ¸©è®°å½• -->
        <div class="record-section">
          <div class="section-header">
            <div class="section-icon">ğŸŒ¡ï¸</div>
            <div class="section-title">åŸºç¡€ä½“æ¸©</div>
            <div class="section-status" id="temperatureStatus">æœªè®°å½•</div>
          </div>
          
          <div class="temperature-display">
            <div class="temperature-value" id="temperatureValue">--.-</div>
            <div class="temperature-time" id="temperatureTime">ç‚¹å‡»è¾“å…¥ä½“æ¸©</div>
          </div>
          
          <button class="temperature-input-btn" onclick="showTemperatureKeyboard()">
            è¾“å…¥ä½“æ¸©
          </button>
          
          <div class="temperature-note">
            <span style="font-size: 14px; color: var(--text-secondary);">ğŸ“ æµ‹é‡æ–¹å¼ï¼šå£è…”æ¸©åº¦</span>
          </div>
        </div>

        <!-- ç»é‡è®°å½• -->
        <div class="record-section menstruation-section">
          <div class="section-header">
            <div class="section-icon">ğŸ©¸</div>
            <div class="section-title">æœˆç»ç»é‡</div>
            <div class="section-status" id="menstruationStatus">æ— </div>
          </div>
          
          <div class="flow-description" id="flowDescription">
            é€‰æ‹©æ¹¿é€çš„å«ç”Ÿå·¾æ•°é‡
          </div>
          
          <div class="pad-selector" id="padSelector">
            <div class="pad-options">
              <button class="pad-option active" data-count="0">
                <div class="pad-icon">âšª</div>
                <div class="pad-label">æ— </div>
              </button>
              <button class="pad-option" data-count="1">
                <div class="pad-icon">ğŸ©¸</div>
                <div class="pad-label">1å¼ </div>
              </button>
              <button class="pad-option" data-count="2">
                <div class="pad-icon">ğŸ©¸ğŸ©¸</div>
                <div class="pad-label">2å¼ </div>
              </button>
              <button class="pad-option" data-count="3">
                <div class="pad-icon">ğŸ©¸ğŸ©¸ğŸ©¸</div>
                <div class="pad-label">3å¼ </div>
              </button>
              <button class="pad-option" data-count="4">
                <div class="pad-icon">ğŸ©¸ğŸ©¸ğŸ©¸ğŸ©¸</div>
                <div class="pad-label">4å¼ </div>
              </button>
              <button class="pad-option" data-count="5">
                <div class="pad-icon">ğŸ©¸ğŸ©¸ğŸ©¸ğŸ©¸ğŸ©¸+</div>
                <div class="pad-label">5å¼ +</div>
              </button>
            </div>
            <div class="pad-description" id="padDescription">
              æ— ç»è¡€
            </div>
          </div>
          
          <div class="flow-options">
            <button class="option-btn" data-start="true">ç»æœŸå¼€å§‹</button>
            <button class="option-btn" data-end="true">ç»æœŸç»“æŸ</button>
          </div>
        </div>

        <!-- åŒæˆ¿è®°å½• -->
        <div class="record-section intimacy-section">
          <div class="section-header">
            <div class="section-icon">ğŸ’•</div>
            <div class="section-title">åŒæˆ¿è®°å½•</div>
            <div class="section-status" id="intimacyStatus">æœªè®°å½•</div>
          </div>
          
          <div class="intimacy-toggle" onclick="toggleIntimacy()">
            <span>ä»Šæ—¥åŒæˆ¿</span>
            <div class="toggle-switch" id="intimacySwitch">
              <div class="toggle-thumb"></div>
            </div>
          </div>
          
          <div class="intimacy-details" id="intimacyDetails">
            <div class="time-input">
              <label>æ—¶é—´:</label>
              <input type="time" class="input-field" id="intimacyTime" value="22:00">
            </div>
            
            <div class="time-input">
              <label>ä¿æŠ¤:</label>
              <select class="input-field" id="protectionSelect">
                <option value="false">æ— ä¿æŠ¤æªæ–½</option>
                <option value="true">æœ‰ä¿æŠ¤æªæ–½</option>
              </select>
            </div>
            
            <div class="time-input">
              <label>å¤‡æ³¨:</label>
              <input type="text" class="input-field" id="intimacyNotes" placeholder="å¯é€‰">
            </div>
          </div>
        </div>

        <!-- ç—‡çŠ¶è®°å½• -->
        <div class="record-section">
          <div class="section-header">
            <div class="section-icon">ğŸ“</div>
            <div class="section-title">ç—‡çŠ¶å¤‡æ³¨</div>
            <div class="section-status">å¯é€‰</div>
          </div>
          
          <textarea class="input-field" id="symptomsNotes" rows="3" 
                    placeholder="è®°å½•ä»Šæ—¥èº«ä½“çŠ¶å†µã€ç—‡çŠ¶ç­‰..."></textarea>
        </div>
      </div>
    </div>

    <!-- ä¿å­˜æŒ‰é’® -->
    <div class="save-section">
      <button class="save-btn" onclick="saveRecord()">
        ä¿å­˜ä»Šæ—¥è®°å½•
      </button>
    </div>

    <!-- TabBar å¯¼èˆª -->
    <div class="tabbar">
      <a href="index.html" class="tab-item" data-page="index">
        <div class="tab-icon">ğŸ </div>
        <div>é¦–é¡µ</div>
      </a>
      <a href="record.html" class="tab-item active" data-page="record">
        <div class="tab-icon">ğŸ“</div>
        <div>è®°å½•</div>
      </a>
      <a href="chart.html" class="tab-item" data-page="chart">
        <div class="tab-icon">ğŸ“Š</div>
        <div>å›¾è¡¨</div>
      </a>
      <a href="calendar.html" class="tab-item" data-page="calendar">
        <div class="tab-icon">ğŸ“…</div>
        <div>æ—¥å†</div>
      </a>
      <a href="settings.html" class="tab-item" data-page="settings">
        <div class="tab-icon">âš™ï¸</div>
        <div>è®¾ç½®</div>
      </a>
    </div>

    <!-- ä½“æ¸©è¾“å…¥é”®ç›˜å¼¹çª— -->
    <div class="keyboard-modal" id="temperatureKeyboard">
      <div id="keyboardContainer"></div>
    </div>
  </div>

  <script src="../assets/js/common.js"></script>
  <script>
    // è®°å½•é¡µé¢çš„çŠ¶æ€
    let currentDate = new Date();
    let currentRecord = {
      temperature: null,
      menstruation: { flow: 'none' },
      intimacy: [],
      symptoms: ''
    };
    
    let temperatureKeyboard = null;
    let flowSlider = null;

    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
    });

    function initializePage() {
      updateDateDisplay();
      initializeTemperatureOptions();
      initializePadSelector();
      initializeMenstruationOptions();
      loadTodayRecord();
    }

    function updateDateDisplay() {
      const dateElement = document.getElementById('selectedDate');
      const today = new Date();
      
      if (currentDate.toDateString() === today.toDateString()) {
        dateElement.textContent = `ä»Šå¤© ${formatDate(currentDate, 'MæœˆDæ—¥')}`;
      } else {
        dateElement.textContent = formatDate(currentDate, 'MæœˆDæ—¥');
      }
    }

    function formatDate(date, format) {
      const month = date.getMonth() + 1;
      const day = date.getDate();
      
      return format
        .replace('M', month)
        .replace('D', day);
    }

    // æ—¥æœŸå¯¼èˆª
    document.getElementById('prevDay').onclick = function() {
      currentDate.setDate(currentDate.getDate() - 1);
      updateDateDisplay();
      loadTodayRecord();
    };

    document.getElementById('nextDay').onclick = function() {
      currentDate.setDate(currentDate.getDate() + 1);
      updateDateDisplay();
      loadTodayRecord();
    };

    // ä½“æ¸©ç›¸å…³åŠŸèƒ½
    function initializeTemperatureOptions() {
      // ä½“æ¸©ç°åœ¨å›ºå®šä¸ºå£è…”æ¸©åº¦ï¼Œä¸éœ€è¦é€‰æ‹©
      console.log('ä½“æ¸©æµ‹é‡æ–¹å¼ï¼šå£è…”æ¸©åº¦');
    }

    function showTemperatureKeyboard() {
      if (!temperatureKeyboard) {
        temperatureKeyboard = new NumberKeyboard('keyboardContainer', {
          maxLength: 4,
          allowDecimal: true,
          onConfirm: function(value) {
            setTemperature(parseFloat(value));
            hideTemperatureKeyboard();
          }
        });
      }
      
      document.getElementById('temperatureKeyboard').classList.add('show');
    }

    function hideTemperatureKeyboard() {
      document.getElementById('temperatureKeyboard').classList.remove('show');
    }

    function setTemperature(value) {
      if (value >= 35.0 && value <= 42.0) {
        currentRecord.temperature = {
          value: value,
          time: new Date().toTimeString().substr(0, 5),
          method: 'oral'  // å›ºå®šä¸ºå£è…”æ¸©åº¦
        };
        
        document.getElementById('temperatureValue').textContent = value.toFixed(1);
        document.getElementById('temperatureTime').textContent = 
          `è®°å½•æ—¶é—´: ${currentRecord.temperature.time}`;
        document.getElementById('temperatureStatus').textContent = 'å·²è®°å½•';
        document.getElementById('temperatureStatus').classList.add('recorded');
        
        Toast.success('ä½“æ¸©è®°å½•æˆåŠŸ');
      } else {
        Toast.error('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½“æ¸©å€¼ (35.0-42.0Â°C)');
      }
    }

    // ç»é‡ç›¸å…³åŠŸèƒ½ - æ”¹ä¸ºå«ç”Ÿå·¾æ•°é‡é€‰æ‹©
    function initializePadSelector() {
      const padOptions = document.querySelectorAll('.pad-option');
      const padDescription = document.getElementById('padDescription');
      const menstruationStatus = document.getElementById('menstruationStatus');
      
      const descriptions = {
        0: 'æ— ç»è¡€',
        1: 'è½»å¾®ç»è¡€ï¼Œæ¹¿é€1å¼ å«ç”Ÿå·¾',
        2: 'å°‘é‡ç»è¡€ï¼Œæ¹¿é€2å¼ å«ç”Ÿå·¾', 
        3: 'ä¸­ç­‰ç»è¡€ï¼Œæ¹¿é€3å¼ å«ç”Ÿå·¾',
        4: 'è¾ƒå¤šç»è¡€ï¼Œæ¹¿é€4å¼ å«ç”Ÿå·¾',
        5: 'å¤§é‡ç»è¡€ï¼Œæ¹¿é€5å¼ æˆ–æ›´å¤šå«ç”Ÿå·¾'
      };
      
      const statusLabels = {
        0: 'æ— ',
        1: '1å¼ ',
        2: '2å¼ ',
        3: '3å¼ ', 
        4: '4å¼ ',
        5: '5å¼ +'
      };
      
      padOptions.forEach(option => {
        option.onclick = function() {
          // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
          padOptions.forEach(o => o.classList.remove('active'));
          // æ·»åŠ activeåˆ°å½“å‰é€‰é¡¹
          this.classList.add('active');
          
          const count = parseInt(this.dataset.count);
          currentRecord.menstruation.padCount = count;
          
          // æ›´æ–°æè¿°
          padDescription.textContent = descriptions[count];
          menstruationStatus.textContent = statusLabels[count];
          
          // æ›´æ–°çŠ¶æ€æ ·å¼
          if (count > 0) {
            menstruationStatus.classList.add('recorded');
          } else {
            menstruationStatus.classList.remove('recorded');
          }
        };
      });
    }

    function initializeMenstruationOptions() {
      const options = document.querySelectorAll('.menstruation-section [data-start], .menstruation-section [data-end]');
      options.forEach(option => {
        option.onclick = function() {
          option.classList.toggle('active');
          
          if (option.dataset.start) {
            currentRecord.menstruation.isStart = option.classList.contains('active');
          }
          if (option.dataset.end) {
            currentRecord.menstruation.isEnd = option.classList.contains('active');
          }
        };
      });
    }

    // åŒæˆ¿ç›¸å…³åŠŸèƒ½
    function toggleIntimacy() {
      const toggle = document.getElementById('intimacySwitch');
      const details = document.getElementById('intimacyDetails');
      const status = document.getElementById('intimacyStatus');
      
      toggle.classList.toggle('active');
      details.classList.toggle('show');
      
      if (toggle.classList.contains('active')) {
        currentRecord.intimacy = [{
          time: document.getElementById('intimacyTime').value,
          protection: document.getElementById('protectionSelect').value === 'true',
          notes: document.getElementById('intimacyNotes').value
        }];
        status.textContent = 'å·²è®°å½•';
        status.classList.add('recorded');
      } else {
        currentRecord.intimacy = [];
        status.textContent = 'æœªè®°å½•';
        status.classList.remove('recorded');
      }
    }

    // åŠ è½½å½“æ—¥è®°å½•
    function loadTodayRecord() {
      const dateString = DateUtils.format(currentDate);
      const existingRecord = mockData.records.find(r => r.date === dateString);
      
      if (existingRecord) {
        // åŠ è½½ç°æœ‰è®°å½•
        if (existingRecord.temperature) {
          setTemperature(existingRecord.temperature.value);
        }
        
        if (existingRecord.menstruation && existingRecord.menstruation.padCount !== undefined) {
          const padCount = existingRecord.menstruation.padCount;
          const padOption = document.querySelector(`[data-count="${padCount}"]`);
          if (padOption) {
            document.querySelectorAll('.pad-option').forEach(o => o.classList.remove('active'));
            padOption.classList.add('active');
            padOption.click(); // è§¦å‘ç‚¹å‡»äº‹ä»¶æ¥æ›´æ–°çŠ¶æ€
          }
        }
        
        if (existingRecord.intimacy && existingRecord.intimacy.length > 0) {
          document.getElementById('intimacySwitch').classList.add('active');
          document.getElementById('intimacyDetails').classList.add('show');
          document.getElementById('intimacyTime').value = existingRecord.intimacy[0].time;
          currentRecord.intimacy = existingRecord.intimacy;
        }
      } else {
        // é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
        resetForm();
      }
    }

    function resetForm() {
      currentRecord = {
        temperature: null,
        menstruation: { padCount: 0 },
        intimacy: [],
        symptoms: ''
      };
      
      document.getElementById('temperatureValue').textContent = '--.-';
      document.getElementById('temperatureTime').textContent = 'ç‚¹å‡»è¾“å…¥ä½“æ¸©';
      document.getElementById('temperatureStatus').textContent = 'æœªè®°å½•';
      document.getElementById('temperatureStatus').classList.remove('recorded');
      
      // é‡ç½®å«ç”Ÿå·¾é€‰æ‹©å™¨
      document.querySelectorAll('.pad-option').forEach(o => o.classList.remove('active'));
      document.querySelector('[data-count="0"]').classList.add('active');
      document.getElementById('padDescription').textContent = 'æ— ç»è¡€';
      document.getElementById('menstruationStatus').textContent = 'æ— ';
      
      document.getElementById('intimacySwitch').classList.remove('active');
      document.getElementById('intimacyDetails').classList.remove('show');
      document.getElementById('intimacyStatus').textContent = 'æœªè®°å½•';
      document.getElementById('intimacyStatus').classList.remove('recorded');
    }

    // ä¿å­˜è®°å½•
    function saveRecord() {
      // æ›´æ–°ç—‡çŠ¶å¤‡æ³¨
      currentRecord.symptoms = document.getElementById('symptomsNotes').value;
      
      // æ›´æ–°åŒæˆ¿è®°å½•çš„è¯¦ç»†ä¿¡æ¯
      if (currentRecord.intimacy.length > 0) {
        currentRecord.intimacy[0].time = document.getElementById('intimacyTime').value;
        currentRecord.intimacy[0].protection = document.getElementById('protectionSelect').value === 'true';
        currentRecord.intimacy[0].notes = document.getElementById('intimacyNotes').value;
      }
      
      // æ¨¡æ‹Ÿä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      const dateString = DateUtils.format(currentDate);
      const recordToSave = {
        id: Date.now().toString(),
        date: dateString,
        ...currentRecord,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      console.log('ä¿å­˜è®°å½•:', recordToSave);
      
      Toast.success('è®°å½•ä¿å­˜æˆåŠŸï¼');
      
      // æ¨¡æ‹Ÿä¿å­˜å»¶è¿Ÿåè·³è½¬
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 1000);
    }

    // é”®ç›˜å¼¹çª—èƒŒæ™¯ç‚¹å‡»å…³é—­
    document.getElementById('temperatureKeyboard').onclick = function(e) {
      if (e.target === this) {
        hideTemperatureKeyboard();
      }
    };
  </script>
</body>
</html> 