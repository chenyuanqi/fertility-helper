<!--pages/calendar/calendar.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½æ—¥å†ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ—¥å†å¤´éƒ¨ä¿¡æ¯ -->
    <view class="calendar-header">
      <view class="month-navigation">
        <view class="month-nav-btn prev-btn" bindtap="onPrevMonth">
          <text class="nav-icon">â€¹</text>
        </view>
        <view class="month-year">{{currentYear}}å¹´{{currentMonth}}æœˆ</view>
        <view class="month-nav-btn next-btn" bindtap="onNextMonth">
          <text class="nav-icon">â€º</text>
        </view>
      </view>
      
      <view class="calendar-info">
        <view class="info-item">
          <view class="info-value">{{calendarStats.cycleDay || '--'}}</view>
          <view class="info-label">å‘¨æœŸç¬¬å‡ å¤©</view>
        </view>
        <view class="info-item">
          <view class="info-value">{{calendarStats.recordDays}}</view>
          <view class="info-label">è®°å½•å¤©æ•°</view>
        </view>
        <view class="info-item">
          <view class="info-value">{{calendarStats.predictedOvulation}}</view>
          <view class="info-label">é¢„è®¡æ’åµ</view>
        </view>
      </view>
      
      <!-- å›åˆ°ä»Šå¤©æŒ‰é’® - ä»…å½“ä¸æ˜¯å½“å‰æœˆæ—¶æ˜¾ç¤º -->
      <view wx:if="{{!isCurrentMonth}}" class="today-button-container">
        <button class="today-btn-bottom" bindtap="onToday">
          <text class="today-icon">ğŸ“…</text>
          <text class="today-text">å›åˆ°ä»Šå¤©</text>
        </button>
      </view>
    </view>

    <!-- æ—¥å†ç½‘æ ¼ -->
    <view class="calendar-container" 
          bindtouchstart="onTouchStart" 
          bindtouchmove="onTouchMove" 
          bindtouchend="onTouchEnd">
      <!-- æ˜ŸæœŸæ ‡é¢˜ -->
      <view class="weekday-header">
        <view wx:for="{{weekDays}}" wx:key="*this" class="weekday-item">{{item}}</view>
      </view>
      
      <!-- æ—¥å†ç½‘æ ¼ -->
      <view class="calendar-grid">
        <view wx:for="{{calendarGrid}}" wx:key="date" 
              class="calendar-day {{item.isCurrentMonth ? 'current-month' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{selectedDate === item.date ? 'selected' : ''}} {{item.hasMenstrual ? 'menstruation' : ''}}"
              bindtap="onDateClick"
              data-date="{{item.date}}"
              data-is-current-month="{{item.isCurrentMonth}}">
          
          <!-- èƒ¶å›ŠèƒŒæ™¯ï¼ˆå…ˆé“ºåœ¨åº•å±‚ï¼‰ -->
          <view wx:if="{{item.isFertile}}" class="capsule fertile capsule-{{item.fertileRole || 'single'}}"></view>
          <view wx:if="{{item.isOptimal}}" class="capsule optimal capsule-{{item.optimalRole || 'single'}}"></view>

          <!-- æ—¥æœŸæ•°å­—ä¸å¾½æ ‡ -->
          <view class="day-number">{{item.day}}</view>
          <view wx:if="{{item.isToday}}" class="today-badge">ä»Š</view>
          <view wx:if="{{item.isOvulationDay}}" class="ovulation-badge">æ’åµæ—¥</view>
          
          <!-- æ•°æ®æŒ‡ç¤ºå™¨ -->
          <view wx:if="{{item.hasData}}" class="day-indicators">
            <!-- ä½“æ¸©æŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.hasTemperature}}" 
                  class="indicator-icon temperature {{item.temperatureValue >= 36.8 ? 'high-temp' : ''}}">
              ğŸŒ¡ï¸
            </view>
            
            <!-- ç»æœŸæŒ‡ç¤ºå™¨ï¼ˆå«ç”Ÿå·¾ï¼‰ -->
            <view wx:if="{{item.hasMenstrual}}" 
                  class="indicator-icon menstruation">
              <view class="pad-visual tiny"></view>
            </view>
            
            <!-- åŒæˆ¿æŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.hasIntercourse}}" 
                  class="indicator-icon intimacy">
              ğŸ’•
            </view>
            
            <!-- ç—‡çŠ¶æŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.hasSymptoms}}" 
                  class="indicator-icon symptoms">
              ğŸ“
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ—¥æœŸè¯¦æƒ…å¼¹æ¡† -->
    <view wx:if="{{showDetails}}" class="date-details-modal">
      <view class="date-details-overlay" bindtap="onHideDetails"></view>
      <view class="date-details-content">
        <view class="details-header">
          <view class="selected-date">
            {{currentYear}}å¹´{{currentMonth}}æœˆ{{selectedData.day}}æ—¥è®°å½•
          </view>
          <view class="close-text" bindtap="onHideDetails">å…³é—­</view>
        </view>
        
        <view class="details-grid">
          <view class="detail-card">
            <view class="detail-icon">ğŸŒ¡ï¸</view>
            <view class="detail-title">åŸºç¡€ä½“æ¸©</view>
            <view class="detail-value {{selectedData.hasTemperature ? '' : 'empty'}}">
              {{selectedData.hasTemperature ? selectedData.temperatureValue + 'Â°C' : 'æœªè®°å½•'}}
            </view>
            <view wx:if="{{selectedData.temperatureNote}}" class="note-line" data-note="{{selectedData.temperatureNote}}" bindtap="onNoteTap">
              <text class="note-text">{{selectedData.temperatureNote}}</text>
              <text class="note-more" wx:if="{{selectedData.temperatureNote.length > 16}}"> æŸ¥çœ‹</text>
            </view>
          </view>
          
          <view class="detail-card">
            <view class="detail-icon">
              <view class="pad-visual" style="border-color: {{selectedData.menstrualColorHex || '#ff6b9d'}}"></view>
            </view>
            <view class="detail-title">æœˆç»ç»é‡</view>
            <view class="detail-value {{selectedData.hasMenstrual ? '' : 'empty'}}">
              {{selectedData.hasMenstrual ? selectedData.menstrualLabel : 'æ— '}}
            </view>
            <view wx:if="{{selectedData.menstrualNote}}" class="note-line" data-note="{{selectedData.menstrualNote}}" bindtap="onNoteTap">
              <text class="note-text">{{selectedData.menstrualNote}}</text>
              <text class="note-more" wx:if="{{selectedData.menstrualNote.length > 16}}"> æŸ¥çœ‹</text>
            </view>
          </view>
          
          <view class="detail-card">
            <view class="detail-icon">ğŸ’•</view>
            <view class="detail-title">åŒæˆ¿è®°å½•</view>
            <view class="detail-value {{selectedData.hasIntercourse ? '' : 'empty'}}">
              {{selectedData.hasIntercourse ? selectedData.intercourseCount + 'æ¬¡' : 'æ— '}}
            </view>
            <view wx:if="{{selectedData.intercourseNote}}" class="note-line" data-note="{{selectedData.intercourseNote}}" bindtap="onNoteTap">
              <text class="note-text">{{selectedData.intercourseNote}}</text>
              <text class="note-more" wx:if="{{selectedData.intercourseNote.length > 16}}"> æŸ¥çœ‹</text>
            </view>
          </view>
          
          <view class="detail-card">
            <view class="detail-icon">ğŸ“</view>
            <view class="detail-title">ç—‡çŠ¶å¤‡æ³¨</view>
            <view class="detail-value {{selectedData.hasSymptoms ? '' : 'empty'}}">
              {{selectedData.hasSymptoms ? 'æœ‰å¤‡æ³¨' : 'æ— '}}
            </view>
          </view>
          
          
        </view>
        
        <view class="details-actions">
          <button class="action-btn" bindtap="onEditDate">ç¼–è¾‘è®°å½•</button>
        </view>
      </view>
    </view>

    <!-- å›¾ä¾‹è¯´æ˜ -->
    <view class="calendar-legend">
      <view class="legend-title">å›¾ä¾‹è¯´æ˜</view>
      <view class="legend-grid">
        <view class="legend-item">
          <text class="legend-icon">ğŸŒ¡ï¸</text>
          <text>åŸºç¡€ä½“æ¸©</text>
        </view>
        <view class="legend-item">
          <view class="pad-visual tiny" style="margin-right:8rpx;"></view>
          <text>æœˆç»è®°å½•</text>
        </view>
        <view class="legend-item">
          <text class="legend-icon">ğŸ’•</text>
          <text>åŒæˆ¿è®°å½•</text>
        </view>
        <view class="legend-item">
          <text class="legend-icon">ğŸ“</text>
          <text>ç—‡çŠ¶å¤‡æ³¨</text>
        </view>
        <view class="legend-item">
          <view class="legend-square today-legend"></view>
          <text>ä»Šå¤©</text>
        </view>
        <view class="legend-item">
          <view class="legend-square menstruation-bg"></view>
          <text>ç»æœŸèƒŒæ™¯</text>
        </view>
        <view class="legend-item">
          <view class="legend-square" style="background: rgba(255, 214, 102, 0.22);"></view>
          <text>æ˜“å­•æœŸ</text>
        </view>
        <view class="legend-item">
          <view class="legend-square" style="background: rgba(255, 107, 107, 0.25);"></view>
          <text>æœ€ä½³å—å­•æœŸ</text>
        </view>
      </view>
    </view>
  </view>
</view>