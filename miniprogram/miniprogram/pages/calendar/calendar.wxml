<!--pages/calendar/calendar.wxml-->
<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载日历中...</text>
  </view>

  <!-- 主要内容 -->
  <view wx:else>
    <!-- 日历头部信息 -->
    <view class="calendar-header">
      <view class="month-navigation">
        <view class="month-nav-btn prev-btn" bindtap="onPrevMonth">
          <text class="nav-icon">‹</text>
        </view>
        <view class="month-year">{{currentYear}}年{{currentMonth}}月</view>
        <view class="month-nav-btn next-btn" bindtap="onNextMonth">
          <text class="nav-icon">›</text>
        </view>
      </view>
      
      <view class="calendar-info">
        <view class="info-item">
          <view class="info-value">{{calendarStats.cycleDay || '--'}}</view>
          <view class="info-label">周期第几天</view>
        </view>
        <view class="info-item">
          <view class="info-value">{{calendarStats.recordDays}}</view>
          <view class="info-label">记录天数</view>
        </view>
        <view class="info-item">
          <view class="info-value">{{calendarStats.predictedOvulation}}</view>
          <view class="info-label">预计排卵</view>
        </view>
      </view>
      
      <!-- 回到今天按钮 - 仅当不是当前月时显示 -->
      <view wx:if="{{!isCurrentMonth}}" class="today-button-container">
        <button class="today-btn-bottom" bindtap="onToday">
          <text class="today-icon">📅</text>
          <text class="today-text">回到今天</text>
        </button>
      </view>
    </view>

    <!-- 日历网格 -->
    <view class="calendar-container" 
          bindtouchstart="onTouchStart" 
          bindtouchmove="onTouchMove" 
          bindtouchend="onTouchEnd">
      <!-- 星期标题 -->
      <view class="weekday-header">
        <view wx:for="{{weekDays}}" wx:key="*this" class="weekday-item">{{item}}</view>
      </view>
      
      <!-- 日历网格 -->
      <view class="calendar-grid">
        <view wx:for="{{calendarGrid}}" wx:key="date" 
              class="calendar-day {{item.isCurrentMonth ? 'current-month' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{selectedDate === item.date ? 'selected' : ''}} {{item.hasMenstrual ? 'menstruation' : ''}}"
              bindtap="onDateClick"
              data-date="{{item.date}}"
              data-is-current-month="{{item.isCurrentMonth}}">
          
          <!-- 胶囊背景（先铺在底层） -->
          <view wx:if="{{item.isFertile}}" class="capsule fertile capsule-{{item.fertileRole || 'single'}}"></view>
          <view wx:if="{{item.isOptimal}}" class="capsule optimal capsule-{{item.optimalRole || 'single'}}"></view>

          <!-- 日期数字与徽标 -->
          <view class="day-number">{{item.day}}</view>
          <view wx:if="{{item.isToday}}" class="today-badge">今</view>
          <view wx:if="{{item.isOvulationDay}}" class="ovulation-badge">排卵日</view>
          
          <!-- 数据指示器 -->
          <view wx:if="{{item.hasData}}" class="day-indicators">
            <!-- 体温指示器 -->
            <view wx:if="{{item.hasTemperature}}" 
                  class="indicator-icon temperature {{item.temperatureValue >= 36.8 ? 'high-temp' : ''}}">
              🌡️
            </view>
            
            <!-- 经期指示器（卫生巾） -->
            <view wx:if="{{item.hasMenstrual}}" 
                  class="indicator-icon menstruation">
              <view class="pad-visual tiny"></view>
            </view>
            
            <!-- 同房指示器 -->
            <view wx:if="{{item.hasIntercourse}}" 
                  class="indicator-icon intimacy">
              💕
            </view>
            
            <!-- 症状指示器 -->
            <view wx:if="{{item.hasSymptoms}}" 
                  class="indicator-icon symptoms">
              📝
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 日期详情弹框 -->
    <view wx:if="{{showDetails}}" class="date-details-modal">
      <view class="date-details-overlay" bindtap="onHideDetails"></view>
      <view class="date-details-content">
        <view class="details-header">
          <view class="selected-date">
            {{currentYear}}年{{currentMonth}}月{{selectedData.day}}日记录
          </view>
          <view class="close-text" bindtap="onHideDetails">关闭</view>
        </view>
        
        <view class="details-grid">
          <view class="detail-card">
            <view class="detail-icon">🌡️</view>
            <view class="detail-title">基础体温</view>
            <view class="detail-value {{selectedData.hasTemperature ? '' : 'empty'}}">
              {{selectedData.hasTemperature ? selectedData.temperatureValue + '°C' : '未记录'}}
            </view>
            <view wx:if="{{selectedData.temperatureNote}}" class="note-line" data-note="{{selectedData.temperatureNote}}" bindtap="onNoteTap">
              <text class="note-text">{{selectedData.temperatureNote}}</text>
              <text class="note-more" wx:if="{{selectedData.temperatureNote.length > 16}}"> 查看</text>
            </view>
          </view>
          
          <view class="detail-card">
            <view class="detail-icon">
              <view class="pad-visual" style="border-color: {{selectedData.menstrualColorHex || '#ff6b9d'}}"></view>
            </view>
            <view class="detail-title">月经经量</view>
            <view class="detail-value {{selectedData.hasMenstrual ? '' : 'empty'}}">
              {{selectedData.hasMenstrual ? selectedData.menstrualLabel : '无'}}
            </view>
            <view wx:if="{{selectedData.menstrualNote}}" class="note-line" data-note="{{selectedData.menstrualNote}}" bindtap="onNoteTap">
              <text class="note-text">{{selectedData.menstrualNote}}</text>
              <text class="note-more" wx:if="{{selectedData.menstrualNote.length > 16}}"> 查看</text>
            </view>
          </view>
          
          <view class="detail-card">
            <view class="detail-icon">💕</view>
            <view class="detail-title">同房记录</view>
            <view class="detail-value {{selectedData.hasIntercourse ? '' : 'empty'}}">
              {{selectedData.hasIntercourse ? selectedData.intercourseCount + '次' : '无'}}
            </view>
            <view wx:if="{{selectedData.intercourseNote}}" class="note-line" data-note="{{selectedData.intercourseNote}}" bindtap="onNoteTap">
              <text class="note-text">{{selectedData.intercourseNote}}</text>
              <text class="note-more" wx:if="{{selectedData.intercourseNote.length > 16}}"> 查看</text>
            </view>
          </view>
          
          <view class="detail-card">
            <view class="detail-icon">📝</view>
            <view class="detail-title">症状备注</view>
            <view class="detail-value {{selectedData.hasSymptoms ? '' : 'empty'}}">
              {{selectedData.hasSymptoms ? '有备注' : '无'}}
            </view>
          </view>
          
          
        </view>
        
        <view class="details-actions">
          <button class="action-btn" bindtap="onEditDate">编辑记录</button>
        </view>
      </view>
    </view>

    <!-- 图例说明 -->
    <view class="calendar-legend">
      <view class="legend-title">图例说明</view>
      <view class="legend-grid">
        <view class="legend-item">
          <text class="legend-icon">🌡️</text>
          <text>基础体温</text>
        </view>
        <view class="legend-item">
          <view class="pad-visual tiny" style="margin-right:8rpx;"></view>
          <text>月经记录</text>
        </view>
        <view class="legend-item">
          <text class="legend-icon">💕</text>
          <text>同房记录</text>
        </view>
        <view class="legend-item">
          <text class="legend-icon">📝</text>
          <text>症状备注</text>
        </view>
        <view class="legend-item">
          <view class="legend-square today-legend"></view>
          <text>今天</text>
        </view>
        <view class="legend-item">
          <view class="legend-square menstruation-bg"></view>
          <text>经期背景</text>
        </view>
        <view class="legend-item">
          <view class="legend-square" style="background: rgba(255, 214, 102, 0.22);"></view>
          <text>易孕期</text>
        </view>
        <view class="legend-item">
          <view class="legend-square" style="background: rgba(255, 107, 107, 0.25);"></view>
          <text>最佳受孕期</text>
        </view>
      </view>
    </view>
  </view>
</view>