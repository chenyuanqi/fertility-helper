<!--pages/calendar/calendar.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½æ—¥å†ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ—¥å†å¤´éƒ¨ä¿¡æ¯ -->
    <view class="calendar-header">
      <view class="month-navigation">
        <button class="month-nav-btn prev-btn" bindtap="onPrevMonth">
          <text class="nav-icon">â€¹</text>
        </button>
        <view class="month-year">{{currentYear}}.{{currentMonth < 10 ? '0' + currentMonth : currentMonth}}</view>
        <button class="month-nav-btn next-btn" bindtap="onNextMonth">
          <text class="nav-icon">â€º</text>
        </button>
      </view>
      
      <view class="calendar-info">
        <view class="info-item">
          <view class="info-value">{{calendarStats.cycleDay || '--'}}</view>
          <view class="info-label">å‘¨æœŸç¬¬å‡ å¤©</view>
        </view>
        <view class="info-item">
          <view class="info-value">{{calendarStats.recordDays}}</view>
          <view class="info-label">è®°å½•å¤©æ•°</view>
        </view>
        <view class="info-item">
          <view class="info-value">{{calendarStats.predictedOvulation}}</view>
          <view class="info-label">é¢„è®¡æ’åµ</view>
        </view>
      </view>
      
      <!-- å›åˆ°ä»Šå¤©æŒ‰é’® - ä»…å½“ä¸æ˜¯å½“å‰æœˆæ—¶æ˜¾ç¤º -->
      <view wx:if="{{!isCurrentMonth}}" class="today-button-container">
        <button class="today-btn-bottom" bindtap="onToday">
          <text class="today-icon">ğŸ“…</text>
          <text class="today-text">å›åˆ°ä»Šå¤©</text>
        </button>
      </view>
    </view>

    <!-- æ—¥å†ç½‘æ ¼ -->
    <view class="calendar-container">
      <!-- æ˜ŸæœŸæ ‡é¢˜ -->
      <view class="weekday-header">
        <view wx:for="{{weekDays}}" wx:key="*this" class="weekday-item">{{item}}</view>
      </view>
      
      <!-- æ—¥å†ç½‘æ ¼ -->
      <view class="calendar-grid">
        <view wx:for="{{calendarGrid}}" wx:key="date" 
              class="calendar-day {{item.isCurrentMonth ? 'current-month' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{selectedDate === item.date ? 'selected' : ''}} {{item.hasMenstrual ? 'menstruation' : ''}}"
              bindtap="onDateClick"
              data-date="{{item.date}}"
              data-is-current-month="{{item.isCurrentMonth}}">
          
          <!-- æ—¥æœŸæ•°å­— -->
          <view class="day-number">{{item.day}}</view>
          
          <!-- æ•°æ®æŒ‡ç¤ºå™¨ -->
          <view wx:if="{{item.hasData}}" class="day-indicators">
            <!-- ä½“æ¸©æŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.hasTemperature}}" 
                  class="indicator temperature {{item.temperatureValue >= 36.8 ? 'high-temp' : ''}}">
            </view>
            
            <!-- ç»æœŸæŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.hasMenstrual}}" 
                  class="indicator menstruation">
            </view>
            
            <!-- åŒæˆ¿æŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.hasIntercourse}}" 
                  class="indicator intimacy">
            </view>
            
            <!-- ç—‡çŠ¶æŒ‡ç¤ºå™¨ -->
            <view wx:if="{{item.hasSymptoms}}" 
                  class="indicator symptoms">
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- é€‰ä¸­æ—¥æœŸè¯¦æƒ… -->
    <view wx:if="{{showDetails}}" class="selected-day-details">
      <view class="details-header">
        <view class="selected-date">
          {{formatDisplayDate(selectedDate)}} {{getDayOfWeekName(selectedDate)}}
        </view>
        <button class="edit-btn" bindtap="onEditDate">ç¼–è¾‘</button>
      </view>
      
      <view class="details-grid">
        <view class="detail-card">
          <view class="detail-icon">ğŸŒ¡ï¸</view>
          <view class="detail-title">åŸºç¡€ä½“æ¸©</view>
          <view class="detail-value {{selectedData.hasTemperature ? '' : 'empty'}}">
            {{selectedData.hasTemperature ? selectedData.temperatureValue + 'Â°C' : 'æœªè®°å½•'}}
          </view>
        </view>
        
        <view class="detail-card">
          <view class="detail-icon">ğŸ©¸</view>
          <view class="detail-title">æœˆç»ç»é‡</view>
          <view class="detail-value {{selectedData.hasMenstrual ? '' : 'empty'}}">
            {{selectedData.hasMenstrual ? (selectedData.menstrualFlow === 'light' ? 'å°‘é‡' : selectedData.menstrualFlow === 'medium' ? 'ä¸­é‡' : 'å¤§é‡') : 'æ— '}}
          </view>
        </view>
        
        <view class="detail-card">
          <view class="detail-icon">ğŸ’•</view>
          <view class="detail-title">åŒæˆ¿è®°å½•</view>
          <view class="detail-value {{selectedData.hasIntercourse ? '' : 'empty'}}">
            {{selectedData.hasIntercourse ? selectedData.intercourseCount + 'æ¬¡' : 'æ— '}}
          </view>
        </view>
        
        <view class="detail-card">
          <view class="detail-icon">ğŸ“</view>
          <view class="detail-title">ç—‡çŠ¶å¤‡æ³¨</view>
          <view class="detail-value {{selectedData.hasSymptoms ? '' : 'empty'}}">
            {{selectedData.hasSymptoms ? 'æœ‰å¤‡æ³¨' : 'æ— '}}
          </view>
        </view>
        
        <view wx:if="{{selectedData.hasSymptoms}}" class="detail-notes">
          <view class="detail-title">è¯¦ç»†å¤‡æ³¨</view>
          <view class="notes-content">{{selectedData.symptoms}}</view>
        </view>
      </view>
      
      <!-- å…³é—­æŒ‰é’® -->
      <view class="close-details" bindtap="onHideDetails">æ”¶èµ·</view>
    </view>

    <!-- å›¾ä¾‹è¯´æ˜ -->
    <view class="calendar-legend">
      <view class="legend-title">å›¾ä¾‹è¯´æ˜</view>
      <view class="legend-grid">
        <view class="legend-item">
          <view class="legend-dot temperature"></view>
          <text>åŸºç¡€ä½“æ¸©</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot menstruation"></view>
          <text>æœˆç»è®°å½•</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot intimacy"></view>
          <text>åŒæˆ¿è®°å½•</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot symptoms"></view>
          <text>ç—‡çŠ¶å¤‡æ³¨</text>
        </view>
        <view class="legend-item">
          <view class="legend-square today-legend"></view>
          <text>ä»Šå¤©</text>
        </view>
        <view class="legend-item">
          <view class="legend-square menstruation-bg"></view>
          <text>ç»æœŸèƒŒæ™¯</text>
        </view>
      </view>
    </view>
  </view>
</view>