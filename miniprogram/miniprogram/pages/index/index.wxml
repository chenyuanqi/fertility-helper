<!--pages/index/index.wxml-->
<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 授权弹窗 -->
  <view wx:elif="{{!hasUserInfo}}" class="auth-container">
    <view class="auth-card">
      <view class="auth-header">
        <view class="auth-logo">👶</view>
        <text class="auth-title">备小孕</text>
      </view>
      <view class="auth-content">
        <text class="auth-desc">为了给您提供更好的服务，我们需要获取您的微信昵称和头像信息</text>
        <text class="auth-privacy">我们将严格保护您的隐私，不会泄露您的个人信息</text>
      </view>
      <view class="auth-footer">
        <button wx:if="{{canIUseGetUserProfile}}" class="auth-button" bindtap="getUserProfile">微信授权登录</button>
        <button wx:else open-type="getUserInfo" bindgetuserinfo="getUserInfo" class="auth-button">微信授权登录</button>
      </view>
    </view>
  </view>

  <!-- 主要内容 -->
  <view wx:else>
    <!-- 日期头部 -->
    <view class="date-header">
      <view class="greeting-section">
        <text class="greeting">你好，{{userSettings.nickname || '小明'}}</text>
        <text class="date-info">{{formatDate(currentDate)}} {{getDayOfWeek(currentDate)}}</text>
      </view>
    </view>

    <!-- 周期信息卡片 -->
    <view class="card cycle-card">
      <view class="card-body">
        <!-- 周期天数单独一行 -->
        <view class="cycle-day-info">
          <text class="cycle-day-text">当前周期第 {{cycleInfo.cycleDay || 0}} 天</text>
        </view>
        
        <!-- 移除当前阶段部分 -->
        <view class="predictions">
          <view class="prediction-cards">
            <view class="prediction-card" wx:if="{{cycleInfo.nextPeriod}}">
              <view class="prediction-content">
                <text class="prediction-label">下次月经（预测）</text>
                <text class="prediction-date">{{cycleInfo.nextPeriod}}</text>
              </view>
            </view>
            <view class="prediction-card" wx:if="{{cycleInfo.ovulationPrediction}}">
              <view class="prediction-content">
                <text class="prediction-label">排卵日（预测）</text>
                <text class="prediction-date">{{cycleInfo.ovulationPrediction}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 今日记录卡片 -->
    <view class="card today-card">
      <view class="card-header">
        <text class="card-title">今日记录</text>
      </view>
      <view class="card-body">
        <view class="today-records">
          <view class="record-item">
            <text class="record-icon">🌡️</text>
            <view class="record-content">
              <text class="record-label">体温</text>
              <text class="record-value">
                {{todayRecord && todayRecord.temperature ? todayRecord.temperature.temperature + '°C' : '未记录'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordTemperature">
              <text class="action-text">{{todayRecord && todayRecord.temperature ? '修改' : '记录'}}</text>
            </view>
          </view>
          
          <view class="record-item">
            <text class="record-icon">🩸</text>
            <view class="record-content">
              <text class="record-label">月经</text>
              <text class="record-value">
                {{todayRecord && todayRecord.menstrual ? 
                  (todayRecord.menstrual.flow === 'none' ? '无月经' :
                   todayRecord.menstrual.flow === 'light' ? '少量' : 
                   todayRecord.menstrual.flow === 'medium' ? '中等' : 
                   todayRecord.menstrual.flow === 'heavy' ? '大量' : '未知') : '未记录'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordMenstrual">
              <text class="action-text">{{todayRecord && todayRecord.menstrual ? '修改' : '记录'}}</text>
            </view>
          </view>
          
          <view class="record-item">
            <text class="record-icon">💕</text>
            <view class="record-content">
              <text class="record-label">同房</text>
              <text class="record-value">
                {{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? 
                  (todayRecord.intercourse[0].type === 'none' ? '无同房' : todayRecord.intercourse.length + '次') : '未记录'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordIntercourse">
              <text class="action-text">{{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? '修改' : '记录'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 快速统计卡片 -->
    <view class="card stats-card">
      <view class="card-header">
        <text class="card-title">最近30天统计</text>
      </view>
      <view class="card-body">
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{quickStats.temperatureRecords}}</text>
            <text class="stat-label">体温记录</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{quickStats.menstrualDays}}</text>
            <text class="stat-label">月经天数</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{quickStats.intercourseCount}}</text>
            <text class="stat-label">同房次数</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 快速导航 -->
    <view class="quick-nav">
      <view class="nav-item" bindtap="viewChart">
        <view class="nav-icon chart-icon"></view>
        <text class="nav-label">查看图表</text>
      </view>
      <view class="nav-item" bindtap="viewCalendar">
        <view class="nav-icon calendar-icon"></view>
        <text class="nav-label">查看日历</text>
      </view>
    </view>
  </view>

  <!-- 浮动操作按钮 -->
  <view class="fab-container">
    <view class="fab-main {{showFabMenu ? 'fab-active' : ''}}" bindtap="toggleFabMenu">
      <text class="fab-icon">{{showFabMenu ? '✕' : '✚'}}</text>
    </view>
    
    <!-- FAB菜单 -->
    <view class="fab-menu {{showFabMenu ? 'fab-menu-show' : ''}}">
      <view class="fab-item fab-temperature" bindtap="quickRecordTemperature">
        <text class="fab-item-icon">🌡️</text>
        <text class="fab-item-label">体温</text>
      </view>
      <view class="fab-item fab-menstrual" bindtap="quickRecordMenstrual">
        <text class="fab-item-icon">🩸</text>
        <text class="fab-item-label">经量</text>
      </view>
      <view class="fab-item fab-intercourse" bindtap="quickRecordIntercourse">
        <text class="fab-item-icon">💕</text>
        <text class="fab-item-label">同房</text>
      </view>
    </view>
  </view>
</view>

<!-- 周期阶段设置模态框 -->
<view class="modal-mask" wx:if="{{showCycleModal}}" catchtap="closeCycleModal">
  <view class="modal cycle-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">设置当前周期阶段</text>
    </view>
    <view class="modal-body">
      <view class="phase-options">
        <view class="phase-option {{selectedPhase === 'menstrual' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="menstrual">
          <view class="phase-icon menstrual-icon">🩸</view>
          <view class="phase-info">
            <text class="phase-name">月经期</text>
            <text class="phase-desc">月经来潮期间</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'follicular' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="follicular">
          <view class="phase-icon follicular-icon">🌱</view>
          <view class="phase-info">
            <text class="phase-name">卵泡期</text>
            <text class="phase-desc">月经结束到排卵前</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'ovulation' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="ovulation">
          <view class="phase-icon ovulation-icon">🥚</view>
          <view class="phase-info">
            <text class="phase-name">排卵期</text>
            <text class="phase-desc">排卵日前后几天</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'luteal' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="luteal">
          <view class="phase-icon luteal-icon">🌙</view>
          <view class="phase-info">
            <text class="phase-name">黄体期</text>
            <text class="phase-desc">排卵后到下次月经前</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-outline" bindtap="closeCycleModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmCyclePhase">确定</button>
    </view>
  </view>
</view>