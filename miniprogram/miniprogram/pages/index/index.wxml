<!--pages/index/index.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- æ—¥æœŸå¤´éƒ¨ -->
    <view class="date-header">
      <view class="greeting-section">
        <text class="greeting">ä½ å¥½ï¼Œ{{userSettings.nickname || 'å°æ˜'}}</text>
        <text class="date-info">{{formatDate(currentDate)}} {{getDayOfWeek(currentDate)}}</text>
      </view>
    </view>

    <!-- å‘¨æœŸä¿¡æ¯å¡ç‰‡ -->
    <view class="card cycle-card">
      <view class="card-body">
        <!-- å‘¨æœŸå¤©æ•°å•ç‹¬ä¸€è¡Œ -->
        <view class="cycle-day-info">
          <text class="cycle-day-text">å½“å‰å‘¨æœŸç¬¬ {{cycleInfo.cycleDay || 0}} å¤©</text>
        </view>
        
        <!-- ç§»é™¤å½“å‰é˜¶æ®µéƒ¨åˆ† -->
        <view class="predictions">
          <view class="prediction-cards">
            <view class="prediction-card" wx:if="{{cycleInfo.nextPeriod}}">
              <view class="prediction-content">
                <text class="prediction-label">ä¸‹æ¬¡æœˆç»ï¼ˆé¢„æµ‹ï¼‰</text>
                <text class="prediction-date">{{cycleInfo.nextPeriod}}</text>
              </view>
            </view>
            <view class="prediction-card" wx:if="{{cycleInfo.ovulationPrediction}}">
              <view class="prediction-content">
                <text class="prediction-label">æ’åµæ—¥ï¼ˆé¢„æµ‹ï¼‰</text>
                <text class="prediction-date">{{cycleInfo.ovulationPrediction}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä»Šæ—¥è®°å½•å¡ç‰‡ -->
    <view class="card today-card">
      <view class="card-header">
        <text class="card-title">ä»Šæ—¥è®°å½•</text>
      </view>
      <view class="card-body">
        <view class="today-records">
          <view class="record-item">
            <text class="record-icon">ğŸŒ¡ï¸</text>
            <view class="record-content">
              <text class="record-label">ä½“æ¸©</text>
              <text class="record-value">
                {{todayRecord && todayRecord.temperature ? todayRecord.temperature.temperature + 'Â°C' : 'æœªè®°å½•'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordTemperature">
              <text class="action-text">{{todayRecord && todayRecord.temperature ? 'ä¿®æ”¹' : 'è®°å½•'}}</text>
            </view>
          </view>
          
          <view class="record-item">
            <text class="record-icon">ğŸ©¸</text>
            <view class="record-content">
              <text class="record-label">æœˆç»</text>
              <text class="record-value">
                {{todayRecord && todayRecord.menstrual ? 
                  (todayRecord.menstrual.flow === 'none' ? 'æ— æœˆç»' :
                   todayRecord.menstrual.flow === 'light' ? 'å°‘é‡' : 
                   todayRecord.menstrual.flow === 'medium' ? 'ä¸­ç­‰' : 
                   todayRecord.menstrual.flow === 'heavy' ? 'å¤§é‡' : 'æœªçŸ¥') : 'æœªè®°å½•'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordMenstrual">
              <text class="action-text">{{todayRecord && todayRecord.menstrual ? 'ä¿®æ”¹' : 'è®°å½•'}}</text>
            </view>
          </view>
          
          <view class="record-item">
            <text class="record-icon">ğŸ’•</text>
            <view class="record-content">
              <text class="record-label">åŒæˆ¿</text>
              <text class="record-value">
                {{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? 
                  (todayRecord.intercourse[0].type === 'none' ? 'æ— åŒæˆ¿' : todayRecord.intercourse.length + 'æ¬¡') : 'æœªè®°å½•'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordIntercourse">
              <text class="action-text">{{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? 'ä¿®æ”¹' : 'è®°å½•'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å¿«é€Ÿç»Ÿè®¡å¡ç‰‡ -->
    <view class="card stats-card">
      <view class="card-header">
        <text class="card-title">æœ€è¿‘30å¤©ç»Ÿè®¡</text>
      </view>
      <view class="card-body">
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{quickStats.temperatureRecords}}</text>
            <text class="stat-label">ä½“æ¸©è®°å½•</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{quickStats.menstrualDays}}</text>
            <text class="stat-label">æœˆç»å¤©æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{quickStats.intercourseCount}}</text>
            <text class="stat-label">åŒæˆ¿æ¬¡æ•°</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¿«é€Ÿå¯¼èˆª -->
    <view class="quick-nav">
      <view class="nav-item" bindtap="viewChart">
        <view class="nav-icon chart-icon"></view>
        <text class="nav-label">æŸ¥çœ‹å›¾è¡¨</text>
      </view>
      <view class="nav-item" bindtap="viewCalendar">
        <view class="nav-icon calendar-icon"></view>
        <text class="nav-label">æŸ¥çœ‹æ—¥å†</text>
      </view>
    </view>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container">
    <view class="fab-main {{showFabMenu ? 'fab-active' : ''}}" bindtap="toggleFabMenu">
      <text class="fab-icon">{{showFabMenu ? 'âœ•' : 'âœš'}}</text>
    </view>
    
    <!-- FABèœå• -->
    <view class="fab-menu {{showFabMenu ? 'fab-menu-show' : ''}}">
      <view class="fab-item fab-temperature" bindtap="quickRecordTemperature">
        <text class="fab-item-icon">ğŸŒ¡ï¸</text>
        <text class="fab-item-label">ä½“æ¸©</text>
      </view>
      <view class="fab-item fab-menstrual" bindtap="quickRecordMenstrual">
        <text class="fab-item-icon">ğŸ©¸</text>
        <text class="fab-item-label">ç»é‡</text>
      </view>
      <view class="fab-item fab-intercourse" bindtap="quickRecordIntercourse">
        <text class="fab-item-icon">ğŸ’•</text>
        <text class="fab-item-label">åŒæˆ¿</text>
      </view>
    </view>
  </view>
</view>

<!-- å‘¨æœŸé˜¶æ®µè®¾ç½®æ¨¡æ€æ¡† -->
<view class="modal-mask" wx:if="{{showCycleModal}}" catchtap="closeCycleModal">
  <view class="modal cycle-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è®¾ç½®å½“å‰å‘¨æœŸé˜¶æ®µ</text>
    </view>
    <view class="modal-body">
      <view class="phase-options">
        <view class="phase-option {{selectedPhase === 'menstrual' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="menstrual">
          <view class="phase-icon menstrual-icon">ğŸ©¸</view>
          <view class="phase-info">
            <text class="phase-name">æœˆç»æœŸ</text>
            <text class="phase-desc">æœˆç»æ¥æ½®æœŸé—´</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'follicular' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="follicular">
          <view class="phase-icon follicular-icon">ğŸŒ±</view>
          <view class="phase-info">
            <text class="phase-name">åµæ³¡æœŸ</text>
            <text class="phase-desc">æœˆç»ç»“æŸåˆ°æ’åµå‰</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'ovulation' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="ovulation">
          <view class="phase-icon ovulation-icon">ğŸ¥š</view>
          <view class="phase-info">
            <text class="phase-name">æ’åµæœŸ</text>
            <text class="phase-desc">æ’åµæ—¥å‰åå‡ å¤©</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'luteal' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="luteal">
          <view class="phase-icon luteal-icon">ğŸŒ™</view>
          <view class="phase-info">
            <text class="phase-name">é»„ä½“æœŸ</text>
            <text class="phase-desc">æ’åµååˆ°ä¸‹æ¬¡æœˆç»å‰</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-outline" bindtap="closeCycleModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmCyclePhase">ç¡®å®š</button>
    </view>
  </view>
</view>