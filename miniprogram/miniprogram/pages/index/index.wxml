<!--pages/index/index.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- å¿«æ·è®°å½•å…¥å£ -->
    <view wx:if="{{false}}" class="card quick-record-card" bindtap="goQuickRecord">
      <view class="qr-left">ğŸ“</view>
      <view class="qr-right">
        <view class="qr-title">å¿«æ·è®°å½•</view>
        <view class="qr-desc">è¯­éŸ³/æ–‡å­—ä¸€é”®å¡«ï¼šä½“æ¸©ã€ç»é‡ã€åŒæˆ¿ï¼ˆé»˜è®¤ä»Šå¤©ï¼‰</view>
      </view>
    </view>

    <!-- æ—¥æœŸå¤´éƒ¨ -->
    <view class="date-header">
      <view class="greeting-section">
        <view class="greeting-main">
          <text class="greeting-emoji">{{greetingEmoji}}</text>
          <view class="greeting-text">
            <text class="greeting">{{greeting}}</text>
            <text class="greeting-tip">{{greetingTip}}</text>
          </view>
        </view>
        <text class="date-info">{{formatDate(currentDate)}} {{getDayOfWeek(currentDate)}}</text>
      </view>
    </view>

    <!-- å‘¨æœŸä¿¡æ¯å¡ç‰‡ -->
    <view class="card cycle-card">
      <view class="card-body">
        <!-- æœ‰å‘¨æœŸæ•°æ®æ—¶æ˜¾ç¤º -->
        <view wx:if="{{cycleInfo.hasCycleData && cycleInfo.cycleDay > 0}}" class="cycle-info-content">
          <!-- å‘¨æœŸå¤©æ•° -->
          <view class="cycle-day-info">
            <text class="cycle-day-text">å½“å‰å‘¨æœŸç¬¬ {{cycleInfo.cycleDay}} å¤©</text>
            <text class="cycle-edit-btn" bindtap="showCycleStartModal">ä¿®æ”¹</text>
          </view>
          
          <!-- é¢„æµ‹ä¿¡æ¯ -->
          <view class="predictions">
            <view class="prediction-cards">
              <view class="prediction-card" wx:if="{{cycleInfo.nextPeriod}}">
                <view class="prediction-content">
                  <text class="prediction-label">ä¸‹æ¬¡æœˆç»ï¼ˆé¢„æµ‹ï¼‰</text>
                  <text class="prediction-date">{{cycleInfo.nextPeriod}}</text>
                </view>
              </view>
              <view class="prediction-card" wx:if="{{cycleInfo.ovulationPrediction}}">
                <view class="prediction-content">
                  <text class="prediction-label">æ’åµæ—¥ï¼ˆé¢„æµ‹ï¼‰</text>
                  <text class="prediction-date">{{cycleInfo.ovulationPrediction}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- æœªè®¾ç½®å‘¨æœŸæç¤º -->
        <view wx:else class="no-cycle-info" bindtap="showCycleStartModal">
          <view class="no-cycle-icon">ğŸ“…</view>
          <text class="no-cycle-text">è®¾ç½®å‘¨æœŸå¼€å§‹æ—¥æœŸ</text>
          <text class="no-cycle-desc">è®°å½•æ‚¨çš„æœˆç»ç¬¬ä¸€å¤©ï¼Œå¼€å¯æ™ºèƒ½å‘¨æœŸè¿½è¸ª</text>
        </view>
      </view>
    </view>

    <!-- ä»Šæ—¥è®°å½•å¡ç‰‡ -->

    <!-- ä»Šæ—¥è®°å½•å¡ç‰‡ -->
    <view class="card today-card">
      <view class="card-header">
        <text class="card-title">ä»Šæ—¥è®°å½•</text>
        <view class="record-progress">
          <text class="progress-text">{{recordsProgress.completed}}/{{recordsProgress.total}}</text>
          <view class="progress-bar">
            <view class="progress-bar-fill {{recordsProgress.percent === 100 ? 'complete' : ''}}" style="width: {{recordsProgress.percent}}%"></view>
          </view>
        </view>
      </view>
      <view class="card-body">
        <view class="today-records modern">
          <!-- ä½“æ¸© -->
          <view class="record-item temperature">
            <view class="row-grid">
              <view class="icon-badge">ğŸŒ¡ï¸</view>
              <text class="record-label">ä½“æ¸©</text>
              <text class="record-value">
                {{todayRecord && todayRecord.temperature ? todayRecord.temperature.temperature + 'Â°C' : 'æœªè®°å½•'}}
              </text>
              <view class="record-action action-link {{todayRecord && todayRecord.temperature ? 'modify' : 'record'}}" bindtap="quickRecordTemperature">
                <text class="action-text">{{todayRecord && todayRecord.temperature ? 'ä¿®æ”¹' : '+ è®°å½•'}}</text>
              </view>
            </view>
          </view>

          <!-- æœˆç» -->
          <view class="record-item menstrual">
            <view class="row-grid">
              <view class="icon-badge">
                <view class="pad-visual small"></view>
              </view>
              <text class="record-label">æœˆç»</text>
              <text class="record-value">
                {{todayRecord && todayRecord.menstrual ? 
                  ((todayRecord.menstrual.padCount || 0) === 0 ? 'æ— æœˆç»' :
                   (todayRecord.menstrual.padCount === 1 ? 'å°‘é‡' : 
                   (todayRecord.menstrual.padCount === 2 ? 'ä¸­ç­‰' : 'å¤§é‡'))) : 'æœªè®°å½•'}}
              </text>
              <view class="record-action action-link {{todayRecord && todayRecord.menstrual ? 'modify' : 'record'}}" bindtap="quickRecordMenstrual">
                <text class="action-text">{{todayRecord && todayRecord.menstrual ? 'ä¿®æ”¹' : '+ è®°å½•'}}</text>
              </view>
            </view>
          </view>

          <!-- åŒæˆ¿ -->
          <view class="record-item intercourse">
            <view class="row-grid">
              <view class="icon-badge">ğŸ’•</view>
              <text class="record-label">åŒæˆ¿</text>
              <text class="record-value">
                {{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? 
                  (todayRecord.intercourse[0].type === 'none' ? 'æ— åŒæˆ¿' : todayRecord.intercourse.length + 'æ¬¡') : 'æœªè®°å½•'}}
              </text>
              <view class="record-action action-link {{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? 'modify' : 'record'}}" bindtap="quickRecordIntercourse">
                <text class="action-text">{{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? 'ä¿®æ”¹' : '+ è®°å½•'}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å¿«é€Ÿç»Ÿè®¡å¡ç‰‡ -->
    <view class="card stats-card">
      <view class="card-header">
        <text class="card-title">æœ€è¿‘30å¤©ç»Ÿè®¡</text>
      </view>
      <view class="card-body">
        <view class="stats-grid">
          <view class="stat-item clickable" bindtap="showStatsExplanation" data-type="temperature">
            <text class="stat-value">{{quickStats.temperatureRecords}}</text>
            <view class="stat-label-row">
              <text class="stat-label">ä½“æ¸©è®°å½•</text>
              <text class="stat-info-icon">â„¹ï¸</text>
            </view>
          </view>
          <view class="stat-item clickable" bindtap="showStatsExplanation" data-type="menstrual">
            <text class="stat-value">{{quickStats.menstrualDays}}</text>
            <view class="stat-label-row">
              <text class="stat-label">æœˆç»å¤©æ•°</text>
              <text class="stat-info-icon">â„¹ï¸</text>
            </view>
          </view>
          <view class="stat-item clickable" bindtap="showStatsExplanation" data-type="intercourse">
            <text class="stat-value">{{quickStats.intercourseCount}}</text>
            <view class="stat-label-row">
              <text class="stat-label">åŒæˆ¿æ¬¡æ•°</text>
              <text class="stat-info-icon">â„¹ï¸</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å¿«é€Ÿå¯¼èˆª -->
    <view class="quick-nav">
      <view class="nav-item" bindtap="viewChart">
        <view class="nav-icon chart-icon"></view>
        <text class="nav-label">æŸ¥çœ‹å›¾è¡¨</text>
      </view>
      <view class="nav-item" bindtap="viewCalendar">
        <view class="nav-icon calendar-icon"></view>
        <text class="nav-label">æŸ¥çœ‹æ—¥å†</text>
      </view>
    </view>

    <!-- æ™ºèƒ½åˆ†æå¡ç‰‡ï¼ˆç§»åŠ¨åˆ°é¡µé¢åº•éƒ¨ï¼‰ -->
    <view class="card smart-analysis-card" wx:if="{{smartAnalysis.ovulationWindow && smartAnalysis.fertileWindow && (quickStats.temperatureRecords >= 10 || quickStats.menstrualDays >= 5)}}">
      <view class="card-header">
        <text class="card-title">æ™ºèƒ½åˆ†æ</text>
        <view class="confidence-badge confidence-{{smartAnalysis.confidence}}">
          <text class="confidence-text">{{getConfidenceText()}}</text>
        </view>
      </view>
      <view class="card-body">
        <!-- æ˜“å­•æœŸçŠ¶æ€ -->
        <view class="fertile-status" wx:if="{{smartAnalysis.fertileWindow}}">
          <view class="fertile-status-main">
            <text class="fertile-status-icon">
              {{smartAnalysis.fertileWindow.currentStatus.phase === 'optimal' ? 'ğŸŒŸ' : 
                smartAnalysis.fertileWindow.currentStatus.phase === 'fertile' ? 'ğŸ’–' : 
                smartAnalysis.fertileWindow.currentStatus.phase === 'pre_fertile' ? 'ğŸŒ±' : 'ğŸŒ™'}}
            </text>
            <view class="fertile-status-text">
              <text class="fertile-status-title">{{getFertileStatusText()}}</text>
              <text class="fertile-status-desc" wx:if="{{smartAnalysis.fertileWindow.currentStatus.fertility === 'high'}}">ç°åœ¨æ˜¯å—å­•çš„å¥½æ—¶æœº</text>
              <text class="fertile-status-desc" wx:elif="{{smartAnalysis.fertileWindow.currentStatus.fertility === 'medium'}}">é€‚åº¦çš„å—å­•æ¦‚ç‡</text>
              <text class="fertile-status-desc" wx:else>å—å­•æ¦‚ç‡è¾ƒä½</text>
            </view>
          </view>
        </view>

        <!-- æ™ºèƒ½å»ºè®® -->
        <view class="smart-recommendations" wx:if="{{smartAnalysis.recommendations.length > 0}}">
          <view class="recommendation-item" wx:for="{{smartAnalysis.recommendations}}" wx:key="type">
            <view class="recommendation-icon">
              {{item.type === 'fertility' ? 'ğŸ’¡' : 
                item.type === 'health' ? 'ğŸ¥' : 
                item.type === 'data_quality' ? 'ğŸ“Š' : 
                item.type === 'timing' ? 'â°' : 'ğŸ’­'}}
            </view>
            <view class="recommendation-content">
              <text class="recommendation-title">{{item.title}}</text>
              <text class="recommendation-text">{{item.content}}</text>
            </view>
          </view>
        </view>

        <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® -->
        <view class="analysis-action">
          <button class="btn btn-outline btn-small" bindtap="viewSmartAnalysis">æŸ¥çœ‹è¯¦ç»†åˆ†æ</button>
        </view>
      </view>
    </view>

    <!-- æ•°æ®ä¸è¶³æç¤ºï¼ˆæ”¾åˆ°åº•éƒ¨ï¼Œå’Œä¸Šé¢çš„ if æˆå¯¹ï¼‰ -->
    <view class="card data-tips-card" wx:else>
      <view class="card-header">
        <text class="card-title">å¼€å§‹æ™ºèƒ½åˆ†æ</text>
      </view>
      <view class="card-body">
        <view class="data-tips">
          <text class="data-tips-icon">ğŸ¤–</text>
          <view class="data-tips-content">
            <text class="data-tips-title">AI åŠ©æ‰‹ç­‰å¾…ä¸­</text>
            <text class="data-tips-desc">è®°å½•æ›´å¤šæ•°æ®åï¼Œæˆ‘å°†ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–çš„æ’åµé¢„æµ‹å’Œå¤‡å­•å»ºè®®</text>
          </view>
        </view>
        <view class="data-tips-actions">
          <text class="data-tip-item">ğŸ“Š è‡³å°‘éœ€è¦10å¤©ä½“æ¸©æ•°æ®</text>
          <text class="data-tip-item">ğŸ©¸ è®°å½•2ä¸ªä»¥ä¸Šæœˆç»å‘¨æœŸ</text>
          <text class="data-tip-item">ğŸ’• è®°å½•åŒæˆ¿æƒ…å†µæ›´å‡†ç¡®</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container {{fabMinimized ? 'fab-minimized' : ''}}">
    <view class="fab-main" bindtap="goQuickRecord">
      <text class="fab-icon">âœš</text>
    </view>
  </view>
  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® - æš‚æ—¶éšè— -->
  <!-- 
  <view class="fab-container">
    <view class="fab-main {{showFabMenu ? 'fab-active' : ''}}" bindtap="toggleFabMenu">
      <text class="fab-icon">{{showFabMenu ? 'âœ•' : 'âœš'}}</text>
    </view>
    
    <view class="fab-menu {{showFabMenu ? 'fab-menu-show' : ''}}">
      <view class="fab-item fab-temperature" bindtap="quickRecordTemperature">
        <text class="fab-item-icon">ğŸŒ¡ï¸</text>
        <text class="fab-item-label">ä½“æ¸©</text>
      </view>
      <view class="fab-item fab-menstrual" bindtap="quickRecordMenstrual">
        <text class="fab-item-icon">ğŸ©¸</text>
        <text class="fab-item-label">ç»é‡</text>
      </view>
      <view class="fab-item fab-intercourse" bindtap="quickRecordIntercourse">
        <text class="fab-item-icon">ğŸ’•</text>
        <text class="fab-item-label">åŒæˆ¿</text>
      </view>
    </view>
  </view>
  -->
</view>

<!-- å‘¨æœŸé˜¶æ®µè®¾ç½®æ¨¡æ€æ¡† -->
<view class="modal-mask" wx:if="{{showCycleModal}}" catchtap="closeCycleModal">
  <view class="modal cycle-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è®¾ç½®å½“å‰å‘¨æœŸé˜¶æ®µ</text>
    </view>
    <view class="modal-body">
      <view class="phase-options">
          <view class="phase-option {{selectedPhase === 'menstrual' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="menstrual">
          <view class="phase-icon menstrual-icon">
            <view class="pad-visual small"></view>
          </view>
          <view class="phase-info">
            <text class="phase-name">æœˆç»æœŸ</text>
            <text class="phase-desc">æœˆç»æ¥æ½®æœŸé—´</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'follicular' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="follicular">
          <view class="phase-icon follicular-icon">ğŸŒ±</view>
          <view class="phase-info">
            <text class="phase-name">åµæ³¡æœŸ</text>
            <text class="phase-desc">æœˆç»ç»“æŸåˆ°æ’åµå‰</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'ovulation' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="ovulation">
          <view class="phase-icon ovulation-icon">ğŸ¥š</view>
          <view class="phase-info">
            <text class="phase-name">æ’åµæœŸ</text>
            <text class="phase-desc">æ’åµæ—¥å‰åå‡ å¤©</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'luteal' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="luteal">
          <view class="phase-icon luteal-icon">ğŸŒ™</view>
          <view class="phase-info">
            <text class="phase-name">é»„ä½“æœŸ</text>
            <text class="phase-desc">æ’åµååˆ°ä¸‹æ¬¡æœˆç»å‰</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-outline" bindtap="closeCycleModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmCyclePhase">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- å‘¨æœŸå¼€å§‹æ—¥æœŸè®¾ç½®æ¨¡æ€æ¡† -->
<view class="modal-mask" wx:if="{{showCycleStartModal}}" catchtap="closeCycleStartModal">
  <view class="modal cycle-start-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è®¾ç½®å‘¨æœŸå¼€å§‹æ—¥æœŸ</text>
    </view>
    <view class="modal-body">
      <view class="cycle-start-info">
        <text class="cycle-start-desc">è¯·é€‰æ‹©æ‚¨æœ€è¿‘ä¸€æ¬¡æœˆç»çš„ç¬¬ä¸€å¤©</text>
        <text class="cycle-start-tip">è¿™å°†å¸®åŠ©æˆ‘ä»¬è®¡ç®—æ‚¨çš„å‘¨æœŸå¤©æ•°å’Œé¢„æµ‹æ’åµæœŸ</text>
      </view>
      
      <view class="date-picker-container">
        <picker mode="date" value="{{cycleStartDate}}" start="{{cycleStartMinDate}}" end="{{currentDate}}" bindchange="onCycleStartDateChange">
          <view class="date-picker">
            <text class="date-picker-value">{{cycleStartDate || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</text>
            <text class="date-picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      
      <view class="flow-selector">
        <text class="flow-selector-title">æœˆç»é‡</text>
        <view class="flow-options">
          <view class="flow-option {{cycleStartFlow === 'light' ? 'active' : ''}}" bindtap="selectFlow" data-flow="light">
            <view class="pad-visual small"></view>
            <text class="flow-label">å°‘é‡</text>
          </view>
          <view class="flow-option {{cycleStartFlow === 'medium' ? 'active' : ''}}" bindtap="selectFlow" data-flow="medium">
            <view class="pad-visual small"></view><view class="pad-visual small"></view>
            <text class="flow-label">ä¸­ç­‰</text>
          </view>
          <view class="flow-option {{cycleStartFlow === 'heavy' ? 'active' : ''}}" bindtap="selectFlow" data-flow="heavy">
            <view class="pad-visual small"></view><view class="pad-visual small"></view><view class="pad-visual small"></view>
            <text class="flow-label">å¤§é‡</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-outline" bindtap="closeCycleStartModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmCycleStart">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- ç»Ÿè®¡æ•°æ®è¯´æ˜å¼¹çª— -->
<view class="modal-mask" wx:if="{{showStatsExplanationModal}}" catchtap="closeStatsExplanationModal">
  <view class="explanation-modal" catchtap="stopPropagation">
    <view class="explanation-header">
      <view class="explanation-title">{{statsExplanationTitle}}</view>
      <view class="explanation-close" bindtap="closeStatsExplanationModal">âœ•</view>
    </view>
    <view class="explanation-body">
      <view class="explanation-content">{{statsExplanationContent}}</view>
      <view class="explanation-tips" wx:if="{{statsExplanationTips}}">ğŸ’¡ {{statsExplanationTips}}</view>
    </view>
    <view class="explanation-footer">
      <button class="btn btn-primary btn-block" bindtap="closeStatsExplanationModal">æˆ‘çŸ¥é“äº†</button>
    </view>
  </view>
</view>