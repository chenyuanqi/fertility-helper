<!--pages/index/index.wxml-->
<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 授权弹窗 -->
  <view wx:elif="{{!hasUserInfo}}" class="auth-container">
    <view class="auth-card">
      <view class="auth-header">
        <view class="auth-logo">👶</view>
        <text class="auth-title">备小孕</text>
      </view>
      <view class="auth-content">
        <text class="auth-desc">为了给您提供更好的服务，我们需要获取您的微信昵称和头像信息</text>
        <text class="auth-privacy">我们将严格保护您的隐私，不会泄露您的个人信息</text>
      </view>
      <view class="auth-footer">
        <button wx:if="{{canIUseGetUserProfile}}" class="auth-button" bindtap="getUserProfile">微信授权登录</button>
        <button wx:else open-type="getUserInfo" bindgetuserinfo="getUserInfo" class="auth-button">微信授权登录</button>
      </view>
    </view>
  </view>

  <!-- 主要内容 -->
  <view wx:else>
    <!-- 日期头部 -->
    <view class="date-header">
      <view class="greeting-section">
        <view class="greeting-main">
          <text class="greeting-emoji">{{greetingEmoji}}</text>
          <view class="greeting-text">
            <text class="greeting">{{greeting}} {{userSettings.nickname || '宝贝'}}</text>
            <text class="greeting-tip">{{greetingTip}}</text>
          </view>
        </view>
        <text class="date-info">{{formatDate(currentDate)}} {{getDayOfWeek(currentDate)}}</text>
      </view>
    </view>

    <!-- 周期信息卡片 -->
    <view class="card cycle-card">
      <view class="card-body">
        <!-- 有周期数据时显示 -->
        <view wx:if="{{cycleInfo.hasCycleData && cycleInfo.cycleDay > 0}}" class="cycle-info-content">
          <!-- 周期天数 -->
          <view class="cycle-day-info">
            <text class="cycle-day-text">当前周期第 {{cycleInfo.cycleDay}} 天</text>
            <text class="cycle-edit-btn" bindtap="showCycleStartModal">修改</text>
          </view>
          
          <!-- 预测信息 -->
          <view class="predictions">
            <view class="prediction-cards">
              <view class="prediction-card" wx:if="{{cycleInfo.nextPeriod}}">
                <view class="prediction-content">
                  <text class="prediction-label">下次月经（预测）</text>
                  <text class="prediction-date">{{cycleInfo.nextPeriod}}</text>
                </view>
              </view>
              <view class="prediction-card" wx:if="{{cycleInfo.ovulationPrediction}}">
                <view class="prediction-content">
                  <text class="prediction-label">排卵日（预测）</text>
                  <text class="prediction-date">{{cycleInfo.ovulationPrediction}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 未设置周期提示 -->
        <view wx:else class="no-cycle-info" bindtap="showCycleStartModal">
          <view class="no-cycle-icon">📅</view>
          <text class="no-cycle-text">设置周期开始日期</text>
          <text class="no-cycle-desc">记录您的月经第一天，开启智能周期追踪</text>
        </view>
      </view>
    </view>

    <!-- 今日记录卡片 -->
    <!-- 智能分析卡片 -->
    <view class="card smart-analysis-card" wx:if="{{smartAnalysis.ovulationWindow && smartAnalysis.fertileWindow && (quickStats.temperatureRecords >= 10 || quickStats.menstrualDays >= 5)}}">
      <view class="card-header">
        <text class="card-title">智能分析</text>
        <view class="confidence-badge confidence-{{smartAnalysis.confidence}}">
          <text class="confidence-text">{{getConfidenceText()}}</text>
        </view>
      </view>
      <view class="card-body">
        <!-- 易孕期状态 -->
        <view class="fertile-status" wx:if="{{smartAnalysis.fertileWindow}}">
          <view class="fertile-status-main">
            <text class="fertile-status-icon">
              {{smartAnalysis.fertileWindow.currentStatus.phase === 'optimal' ? '🌟' : 
                smartAnalysis.fertileWindow.currentStatus.phase === 'fertile' ? '💖' : 
                smartAnalysis.fertileWindow.currentStatus.phase === 'pre_fertile' ? '🌱' : '🌙'}}
            </text>
            <view class="fertile-status-text">
              <text class="fertile-status-title">{{getFertileStatusText()}}</text>
              <text class="fertile-status-desc" wx:if="{{smartAnalysis.fertileWindow.currentStatus.fertility === 'high'}}">
                现在是受孕的好时机
              </text>
              <text class="fertile-status-desc" wx:elif="{{smartAnalysis.fertileWindow.currentStatus.fertility === 'medium'}}">
                适度的受孕概率
              </text>
              <text class="fertile-status-desc" wx:else>
                受孕概率较低
              </text>
            </view>
          </view>
        </view>

        <!-- 智能建议 -->
        <view class="smart-recommendations" wx:if="{{smartAnalysis.recommendations.length > 0}}">
          <view class="recommendation-item" wx:for="{{smartAnalysis.recommendations}}" wx:key="type">
            <view class="recommendation-icon">
              {{item.type === 'fertility' ? '💡' : 
                item.type === 'health' ? '🏥' : 
                item.type === 'data_quality' ? '📊' : 
                item.type === 'timing' ? '⏰' : '💭'}}
            </view>
            <view class="recommendation-content">
              <text class="recommendation-title">{{item.title}}</text>
              <text class="recommendation-text">{{item.content}}</text>
            </view>
          </view>
        </view>

        <!-- 查看详情按钮 -->
        <view class="analysis-action">
          <button class="btn btn-outline btn-small" bindtap="viewSmartAnalysis">查看详细分析</button>
        </view>
      </view>
    </view>

    <!-- 数据不足提示 -->
    <view class="card data-tips-card" wx:else>
      <view class="card-header">
        <text class="card-title">开始智能分析</text>
      </view>
      <view class="card-body">
        <view class="data-tips">
          <text class="data-tips-icon">🤖</text>
          <view class="data-tips-content">
            <text class="data-tips-title">AI 助手等待中</text>
            <text class="data-tips-desc">记录更多数据后，我将为您提供个性化的排卵预测和备孕建议</text>
          </view>
        </view>
        <view class="data-tips-actions">
          <text class="data-tip-item">📊 至少需要10天体温数据</text>
          <text class="data-tip-item">🩸 记录2个以上月经周期</text>
          <text class="data-tip-item">💕 记录同房情况更准确</text>
        </view>
      </view>
    </view>

    <!-- 今日记录卡片 -->
    <view class="card today-card">
      <view class="card-header">
        <text class="card-title">今日记录</text>
      </view>
      <view class="card-body">
        <view class="today-records">
          <view class="record-item">
            <text class="record-icon">🌡️</text>
            <view class="record-content">
              <text class="record-label">体温</text>
              <text class="record-value">
                {{todayRecord && todayRecord.temperature ? todayRecord.temperature.temperature + '°C' : '未记录'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordTemperature">
              <text class="action-text">{{todayRecord && todayRecord.temperature ? '修改' : '记录'}}</text>
            </view>
          </view>
          
          <view class="record-item">
            <text class="record-icon">🩸</text>
            <view class="record-content">
              <text class="record-label">月经</text>
              <text class="record-value">
                {{todayRecord && todayRecord.menstrual ? 
                  (todayRecord.menstrual.flow === 'none' ? '无月经' :
                   todayRecord.menstrual.flow === 'light' ? '少量' : 
                   todayRecord.menstrual.flow === 'medium' ? '中等' : 
                   todayRecord.menstrual.flow === 'heavy' ? '大量' : '未知') : '未记录'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordMenstrual">
              <text class="action-text">{{todayRecord && todayRecord.menstrual ? '修改' : '记录'}}</text>
            </view>
          </view>
          
          <view class="record-item">
            <text class="record-icon">💕</text>
            <view class="record-content">
              <text class="record-label">同房</text>
              <text class="record-value">
                {{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? 
                  (todayRecord.intercourse[0].type === 'none' ? '无同房' : todayRecord.intercourse.length + '次') : '未记录'}}
              </text>
            </view>
            <view class="record-action" bindtap="quickRecordIntercourse">
              <text class="action-text">{{todayRecord && todayRecord.intercourse && todayRecord.intercourse.length > 0 ? '修改' : '记录'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 快速统计卡片 -->
    <view class="card stats-card">
      <view class="card-header">
        <text class="card-title">最近30天统计</text>
      </view>
      <view class="card-body">
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{quickStats.temperatureRecords}}</text>
            <text class="stat-label">体温记录</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{quickStats.menstrualDays}}</text>
            <text class="stat-label">月经天数</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{quickStats.intercourseCount}}</text>
            <text class="stat-label">同房次数</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 快速导航 -->
    <view class="quick-nav">
      <view class="nav-item" bindtap="viewChart">
        <view class="nav-icon chart-icon"></view>
        <text class="nav-label">查看图表</text>
      </view>
      <view class="nav-item" bindtap="viewCalendar">
        <view class="nav-icon calendar-icon"></view>
        <text class="nav-label">查看日历</text>
      </view>
    </view>
  </view>

  <!-- 浮动操作按钮 -->
  <view class="fab-container">
    <view class="fab-main {{showFabMenu ? 'fab-active' : ''}}" bindtap="toggleFabMenu">
      <text class="fab-icon">{{showFabMenu ? '✕' : '✚'}}</text>
    </view>
    
    <!-- FAB菜单 -->
    <view class="fab-menu {{showFabMenu ? 'fab-menu-show' : ''}}">
      <view class="fab-item fab-temperature" bindtap="quickRecordTemperature">
        <text class="fab-item-icon">🌡️</text>
        <text class="fab-item-label">体温</text>
      </view>
      <view class="fab-item fab-menstrual" bindtap="quickRecordMenstrual">
        <text class="fab-item-icon">🩸</text>
        <text class="fab-item-label">经量</text>
      </view>
      <view class="fab-item fab-intercourse" bindtap="quickRecordIntercourse">
        <text class="fab-item-icon">💕</text>
        <text class="fab-item-label">同房</text>
      </view>
    </view>
  </view>
</view>

<!-- 周期阶段设置模态框 -->
<view class="modal-mask" wx:if="{{showCycleModal}}" catchtap="closeCycleModal">
  <view class="modal cycle-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">设置当前周期阶段</text>
    </view>
    <view class="modal-body">
      <view class="phase-options">
        <view class="phase-option {{selectedPhase === 'menstrual' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="menstrual">
          <view class="phase-icon menstrual-icon">🩸</view>
          <view class="phase-info">
            <text class="phase-name">月经期</text>
            <text class="phase-desc">月经来潮期间</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'follicular' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="follicular">
          <view class="phase-icon follicular-icon">🌱</view>
          <view class="phase-info">
            <text class="phase-name">卵泡期</text>
            <text class="phase-desc">月经结束到排卵前</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'ovulation' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="ovulation">
          <view class="phase-icon ovulation-icon">🥚</view>
          <view class="phase-info">
            <text class="phase-name">排卵期</text>
            <text class="phase-desc">排卵日前后几天</text>
          </view>
        </view>
        
        <view class="phase-option {{selectedPhase === 'luteal' ? 'active' : ''}}" 
              bindtap="selectPhase" data-phase="luteal">
          <view class="phase-icon luteal-icon">🌙</view>
          <view class="phase-info">
            <text class="phase-name">黄体期</text>
            <text class="phase-desc">排卵后到下次月经前</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-outline" bindtap="closeCycleModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmCyclePhase">确定</button>
    </view>
  </view>
</view>

<!-- 周期开始日期设置模态框 -->
<view class="modal-mask" wx:if="{{showCycleStartModal}}" catchtap="closeCycleStartModal">
  <view class="modal cycle-start-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">设置周期开始日期</text>
    </view>
    <view class="modal-body">
      <view class="cycle-start-info">
        <text class="cycle-start-desc">请选择您最近一次月经的第一天</text>
        <text class="cycle-start-tip">这将帮助我们计算您的周期天数和预测排卵期</text>
      </view>
      
      <view class="date-picker-container">
        <picker mode="date" value="{{cycleStartDate}}" start="{{cycleStartMinDate}}" end="{{currentDate}}" bindchange="onCycleStartDateChange">
          <view class="date-picker">
            <text class="date-picker-value">{{cycleStartDate || '请选择日期'}}</text>
            <text class="date-picker-arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="flow-selector">
        <text class="flow-selector-title">月经量</text>
        <view class="flow-options">
          <view class="flow-option {{cycleStartFlow === 'light' ? 'active' : ''}}" bindtap="selectFlow" data-flow="light">
            <text class="flow-icon">💧</text>
            <text class="flow-label">少量</text>
          </view>
          <view class="flow-option {{cycleStartFlow === 'medium' ? 'active' : ''}}" bindtap="selectFlow" data-flow="medium">
            <text class="flow-icon">💧💧</text>
            <text class="flow-label">中等</text>
          </view>
          <view class="flow-option {{cycleStartFlow === 'heavy' ? 'active' : ''}}" bindtap="selectFlow" data-flow="heavy">
            <text class="flow-icon">💧💧💧</text>
            <text class="flow-label">大量</text>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-outline" bindtap="closeCycleStartModal">取消</button>
      <button class="btn btn-primary" bindtap="confirmCycleStart">确定</button>
    </view>
  </view>
</view>
