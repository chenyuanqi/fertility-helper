<!--pages/chart/chart.wxml-->
<view class="chart-page">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading">
    <text>åŠ è½½å›¾è¡¨æ•°æ®ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- å‘¨æœŸä¿¡æ¯å¤´éƒ¨ -->
    <view class="chart-header">
      <!-- å¯¼èˆªæŒ‰é’®å’Œå‘¨æœŸå¤©æ•°æ”¾åœ¨åŒä¸€è¡Œ -->
      <view class="cycle-nav-row">
        <button class="nav-btn" bindtap="onPreviousCycle">
          <text class="nav-icon">â€¹</text>
        </button>
        
        <view class="cycle-day-container">
          <text class="cycle-day">å‘¨æœŸç»Ÿè®¡</text>
        </view>
        
        <button class="nav-btn" bindtap="onNextCycle">
          <text class="nav-icon">â€º</text>
        </button>
      </view>
      
      <!-- æ—¥æœŸèŒƒå›´å•ç‹¬æ”¾ä¸€è¡Œ -->
      <view class="cycle-date-row">
        <text class="cycle-date-range">{{dateRange.start}} è‡³ {{dateRange.end}}</text>
      </view>
      
      <view class="cycle-stats">
        <view class="stat-item">
          <text class="stat-value">{{cycleStats.averageTemp || '0.0'}}Â°C</text>
          <text class="stat-label">å¹³å‡ä½“æ¸©</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{cycleStats.predictedOvulation || '--'}}</text>
          <text class="stat-label">é¢„è®¡æ’åµ</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{cycleStats.temperatureRecords || 0}}</text>
          <text class="stat-label">ä½“æ¸©è®°å½•</text>
        </view>
      </view>
    </view>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <view class="chart-container">
      <view class="chart-controls">
        <view class="view-mode-tabs">
          <button class="tab-btn {{viewMode === 'all' ? 'active' : ''}}" 
                  bindtap="onViewModeChange" data-mode="all">
            ğŸ“Š å…¨éƒ¨æ•°æ®
          </button>
          <button class="tab-btn {{viewMode === 'temperature' ? 'active' : ''}}" 
                  bindtap="onViewModeChange" data-mode="temperature">
            ğŸŒ¡ï¸ ä»…ä½“æ¸©
          </button>
        </view>
        
        <view class="chart-actions">
          <button class="chart-btn {{isZoomed ? 'active' : ''}}" bindtap="onZoomToggle">
            <text class="btn-icon">{{isZoomed ? 'ğŸ”' : 'ğŸ”'}}</text>
          </button>
        </view>
      </view>
      
      <view class="chart-title">
        <text>ğŸ“ˆ å¤‡å­•æ•°æ®å›¾è¡¨</text>
      </view>
      
      <!-- ä¸‰åˆä¸€å›¾è¡¨ -->
      <view class="chart-mock" id="chartArea" bindtap="onChartTap">
        <!-- æ—¥æœŸè½´ -->
        <view class="chart-date-axis">
          <view class="date-item" wx:for="{{chartDateLabels}}" wx:key="*this">
            <text>{{item}}</text>
          </view>
        </view>
        
        <!-- æ¸©åº¦è½´ -->
        <view class="chart-temp-axis">
          <view class="temp-item" wx:for="{{['37.5', '37.0', '36.5', '36.0']}}" wx:key="*this">
            <text>{{item}}</text>
          </view>
        </view>
        
        <!-- å›¾è¡¨æ•°æ®åŒºåŸŸ -->
        <view class="chart-data-area">
          <!-- ä½“æ¸©è¿æ¥çº¿ - ä½¿ç”¨Canvasç»˜åˆ¶ -->
          <canvas class="temperature-line-canvas" 
                  id="temperatureCanvas"
                  type="2d"
                  disable-scroll="true">
          </canvas>
          
          <!-- æ•°æ®ç‚¹ -->
          <view wx:for="{{chartDataPoints}}" wx:key="date" class="data-point" 
                style="left: {{item.x}}%; top: {{item.y}}%;" 
                bindtap="onPointClick" data-point="{{item}}">
            
            <!-- ä½“æ¸©ç‚¹ï¼ˆåŸºç¡€åœ†åœˆï¼‰ -->
            <view wx:if="{{item.hasTemperature}}" class="point-circle temperature-point">
              <!-- æœˆç»æ ‡è®° -->
              <view wx:if="{{item.hasMenstrual}}" class="point-marker menstrual-marker"></view>
              <!-- åŒæˆ¿æ ‡è®° -->
              <view wx:if="{{item.hasIntercourse}}" class="point-marker intercourse-marker"></view>
              <!-- æ’åµé¢„æµ‹æ ‡è®° -->
              <view wx:if="{{item.isOvulationPredicted}}" class="point-marker ovulation-marker"></view>
            </view>
            
            <!-- æ— ä½“æ¸©ä½†æœ‰å…¶ä»–æ•°æ®çš„ç‚¹ -->
            <view wx:elif="{{item.hasMenstrual || item.hasIntercourse}}" class="point-circle no-temp-point">
              <!-- æœˆç»æ ‡è®° -->
              <view wx:if="{{item.hasMenstrual}}" class="point-marker menstrual-marker"></view>
              <!-- åŒæˆ¿æ ‡è®° -->
              <view wx:if="{{item.hasIntercourse}}" class="point-marker intercourse-marker"></view>
            </view>
            
            <!-- ä½“æ¸©æ ‡ç­¾ -->
            <text wx:if="{{item.hasTemperature}}" class="point-label">{{item.temperatureValue}}Â°C</text>
          </view>
        </view>
        
        <view class="chart-hint">
          <text class="chart-hint-icon">ğŸ”</text>
          <text>ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹</text>
        </view>
      </view>
    </view>

    <!-- å›¾ä¾‹è¯´æ˜ -->
    <view class="chart-legend">
      <view class="legend-items">
        <view class="legend-item">
          <view class="legend-icon temperature"></view>
          <text>åŸºç¡€ä½“æ¸©</text>
        </view>
        <view class="legend-item">
          <view class="legend-icon menstruation"></view>
          <text>æœˆç»è®°å½•</text>
        </view>
        <view class="legend-item">
          <view class="legend-icon intimacy"></view>
          <text>åŒæˆ¿è®°å½•</text>
        </view>
        <view class="legend-item">
          <view class="legend-icon ovulation"></view>
          <text>æ’åµé¢„æµ‹</text>
        </view>
        <view class="legend-item">
          <view class="legend-icon coverline"></view>
          <text>è¦†ç›–çº¿</text>
        </view>
      </view>
    </view>

    <!-- æ•°æ®è¯¦æƒ…å¼¹çª— -->
    <view class="data-details" wx:if="{{selectedPointData}}">
      <view class="details-header">
        <text class="selected-date">ğŸ“… {{selectedPointData.dateDisplay}}</text>
        <button class="close-btn" bindtap="closeDetails">âœ•</button>
      </view>
      <view class="details-content">
        <view class="detail-item">
          <text class="detail-value">ğŸŒ¡ï¸ {{selectedPointData.temperature}}</text>
          <text class="detail-label">åŸºç¡€ä½“æ¸©</text>
        </view>
        <view class="detail-item">
          <text class="detail-value">ğŸ©¸ {{selectedPointData.menstruation}}</text>
          <text class="detail-label">æœˆç»æƒ…å†µ</text>
        </view>
        <view class="detail-item">
          <text class="detail-value">ğŸ’• {{selectedPointData.intercourse}}</text>
          <text class="detail-label">åŒæˆ¿è®°å½•</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å…¨å±å›¾è¡¨æ¨¡æ€æ¡† -->
  <view class="chart-fullscreen" wx:if="{{showFullscreenChart}}">
    <view class="chart-fullscreen-header">
      <text class="chart-fullscreen-title">è¯¦ç»†å›¾è¡¨</text>
      <button class="chart-fullscreen-close" bindtap="closeFullscreenChart">å…³é—­</button>
    </view>
    <view class="chart-fullscreen-content">
      <scroll-view class="chart-scroll-container" scroll-x="true" enhanced="true" show-scrollbar="false">
        <view class="chart-expanded">
          <!-- å…¨å±å›¾è¡¨çš„æ¸©åº¦è½´ -->
          <view class="fullscreen-temp-axis">
            <view class="fullscreen-temp-item" wx:for="{{['37.5', '37.0', '36.5', '36.0']}}" wx:key="*this">
              <text>{{item}}</text>
            </view>
          </view>
          
          <!-- å…¨å±å›¾è¡¨çš„æ—¥æœŸè½´ -->
          <view class="fullscreen-date-axis">
            <view class="fullscreen-date-item" wx:for="{{chartDateLabels}}" wx:key="*this">
              <text>{{item}}</text>
            </view>
          </view>
          
          <!-- å…¨å±å›¾è¡¨æ•°æ®åŒºåŸŸ -->
          <view class="fullscreen-chart-data-area">
            <!-- ä½“æ¸©è¿æ¥çº¿ -->
            <canvas class="fullscreen-temperature-line-canvas" 
                    id="fullscreenTemperatureCanvas"
                    type="2d"
                    disable-scroll="true">
            </canvas>
            
            <!-- æ•°æ®ç‚¹ -->
            <view wx:for="{{chartDataPoints}}" wx:key="date" class="fullscreen-data-point" 
                  style="left: {{item.x}}%; top: {{item.y}}%;" 
                  bindtap="onPointClick" data-point="{{item}}">
              
              <!-- ä½“æ¸©ç‚¹ï¼ˆåŸºç¡€åœ†åœˆï¼‰ -->
              <view wx:if="{{item.hasTemperature}}" class="fullscreen-point-circle fullscreen-temperature-point">
                <!-- æœˆç»æ ‡è®° -->
                <view wx:if="{{item.hasMenstrual}}" class="fullscreen-point-marker fullscreen-menstrual-marker"></view>
                <!-- åŒæˆ¿æ ‡è®° -->
                <view wx:if="{{item.hasIntercourse}}" class="fullscreen-point-marker fullscreen-intercourse-marker"></view>
                <!-- æ’åµé¢„æµ‹æ ‡è®° -->
                <view wx:if="{{item.isOvulationPredicted}}" class="fullscreen-point-marker fullscreen-ovulation-marker"></view>
              </view>
              
              <!-- æ— ä½“æ¸©ä½†æœ‰å…¶ä»–æ•°æ®çš„ç‚¹ -->
              <view wx:elif="{{item.hasMenstrual || item.hasIntercourse}}" class="fullscreen-point-circle fullscreen-no-temp-point">
                <!-- æœˆç»æ ‡è®° -->
                <view wx:if="{{item.hasMenstrual}}" class="fullscreen-point-marker fullscreen-menstrual-marker"></view>
                <!-- åŒæˆ¿æ ‡è®° -->
                <view wx:if="{{item.hasIntercourse}}" class="fullscreen-point-marker fullscreen-intercourse-marker"></view>
              </view>
              
              <!-- ä½“æ¸©æ ‡ç­¾ -->
              <text wx:if="{{item.hasTemperature}}" class="fullscreen-point-label">{{item.temperatureValue}}Â°C</text>
            </view>
          </view>
        </view>
      </scroll-view>
      <view class="chart-fullscreen-tips">
        <text class="tips-icon">ğŸ‘†</text>
        <text class="tips-text">å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šæ•°æ®</text>
      </view>
      <view class="chart-fullscreen-description">
        <text>æ­¤å›¾è¡¨å±•ç¤ºäº†æ‚¨çš„åŸºç¡€ä½“æ¸©å˜åŒ–ã€æœˆç»å‘¨æœŸå’ŒåŒæˆ¿è®°å½•ï¼Œå¸®åŠ©æ‚¨æ›´å¥½åœ°äº†è§£è‡ªå·±çš„ç”Ÿè‚²å¥åº·çŠ¶å†µã€‚</text>
      </view>
    </view>
  </view>
</view>
