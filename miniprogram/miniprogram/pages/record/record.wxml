<!--pages/record/record.wxml-->
<view class="container">
  <!-- 页面标题显示日期 -->
  <view class="page-title-bar">
    <text class="page-title-date">{{formattedDate}}</text>
  </view>

  <!-- 自动保存提示/保存成功轻提示共用区域 -->
  <view class="auto-save-tip" wx:if="{{hasUnsavedChanges || saveSuccessTip}}">
    <view class="tip-content">
      <text class="tip-text" wx:if="{{saveSuccessTip}}">保存成功</text>
      <text class="tip-text" wx:elif="{{autoSaveCountdown > 0}}">{{autoSaveCountdown}}秒后自动保存</text>
      <text class="tip-text" wx:else>有未保存的更改</text>
      <view class="tip-actions">
        <text class="tip-btn save-btn" bindtap="manualSaveCurrentRecord">保存</text>
        <text class="tip-btn cancel-btn" bindtap="cancelAutoSave">取消</text>
      </view>
    </view>
  </view>

  <!-- 记录类型切换 -->
  <view class="record-type-tabs">
    <view class="tab-item {{recordType === 'temperature' ? 'active' : ''}}" 
          data-type="temperature" bindtap="onRecordTypeChange">
      <text class="tab-icon">🌡️</text>
      <text class="tab-text">体温</text>
    </view>
    <view class="tab-item {{recordType === 'menstrual' ? 'active' : ''}}" 
          data-type="menstrual" bindtap="onRecordTypeChange">
      <text class="tab-icon">🩸</text>
      <text class="tab-text">经量</text>
    </view>
    <view class="tab-item {{recordType === 'intercourse' ? 'active' : ''}}" 
          data-type="intercourse" bindtap="onRecordTypeChange">
      <text class="tab-icon">💕</text>
      <text class="tab-text">同房</text>
    </view>
  </view>

  <!-- 体温记录 -->
  <view class="record-section" wx:if="{{recordType === 'temperature'}}">
    <view class="section-title">
      <text class="title-text">体温记录</text>
      <text class="title-desc">选择基础体温</text>
    </view>

    <view class="form-group">
      <view class="form-label">体温值</view>
      <picker range="{{temperatureOptions}}" range-key="label" value="{{temperatureIndex}}" bindchange="onTemperatureChange">
        <view class="picker-input {{temperatureValue ? 'has-value' : ''}}">
          <text class="picker-text">{{temperatureValue ? temperatureValue + '°C' : '请选择体温'}}</text>
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>

    <view class="form-group">
      <view class="form-label">测量时间</view>
      <picker mode="time" value="{{temperatureTime}}" bindchange="onTemperatureTimeChange">
        <view class="picker-input has-value">
          <text class="picker-text">{{temperatureTime}}</text>
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>

    <view class="form-group">
      <view class="form-label">备注</view>
      <textarea class="textarea-input" 
                placeholder="记录特殊情况，如感冒、熬夜等" 
                value="{{temperatureNote}}"
                bindinput="onTemperatureNoteInput"
                maxlength="100">
      </textarea>
    </view>

    <view class="button-group" wx:if="{{todayRecord && todayRecord.temperature}}">
      <button class="delete-button-full" bindtap="deleteRecord" data-type="temperature">
        删除体温记录
      </button>
    </view>
  </view>

  <!-- 经量记录 -->
  <view class="record-section" wx:if="{{recordType === 'menstrual'}}">
    <view class="section-title">
      <text class="title-text">经量记录</text>
      <text class="title-desc">记录月经流量</text>
    </view>

    <view class="form-group">
      <view class="form-label">经期标记</view>
      <view class="period-markers-new">
        <view class="period-marker-item {{isStartPeriod ? 'active' : ''}}" 
              data-type="start" bindtap="onPeriodMarkerTap">
          <view class="marker-icon">🌸</view>
          <view class="marker-content">
            <text class="marker-title">经期开始</text>
            <text class="marker-desc">标记月经周期开始</text>
          </view>
          <view class="marker-check {{isStartPeriod ? 'checked' : ''}}">
            <text class="check-icon">✓</text>
          </view>
        </view>
        
        <view class="period-marker-item {{isEndPeriod ? 'active' : ''}}" 
              data-type="end" bindtap="onPeriodMarkerTap">
          <view class="marker-icon">🌺</view>
          <view class="marker-content">
            <text class="marker-title">经期结束</text>
            <text class="marker-desc">标记月经周期结束</text>
          </view>
          <view class="marker-check {{isEndPeriod ? 'checked' : ''}}">
            <text class="check-icon">✓</text>
          </view>
        </view>
      </view>
    </view>

    <view class="form-group">
      <view class="form-label">卫生巾数量</view>
      <view class="pad-grid">
        <view class="pad-item {{menstrualPadCount === 0 ? 'active' : ''}}" data-count="0" bindtap="onPadOptionTap">
          <view class="pad-icons">
            <view class="pad-visual empty"><view class="pad-visual-inner"></view></view>
          </view>
          <view class="pad-text">无</view>
        </view>
        <view class="pad-item {{menstrualPadCount === 1 ? 'active' : ''}}" data-count="1" bindtap="onPadOptionTap">
          <view class="pad-icons">
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
          </view>
          <view class="pad-text">1张</view>
        </view>
        <view class="pad-item {{menstrualPadCount === 2 ? 'active' : ''}}" data-count="2" bindtap="onPadOptionTap">
          <view class="pad-icons">
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
          </view>
          <view class="pad-text">2张</view>
        </view>
        <view class="pad-item {{menstrualPadCount === 3 ? 'active' : ''}}" data-count="3" bindtap="onPadOptionTap">
          <view class="pad-icons">
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
          </view>
          <view class="pad-text">3张</view>
        </view>
        <view class="pad-item {{menstrualPadCount === 4 ? 'active' : ''}}" data-count="4" bindtap="onPadOptionTap">
          <view class="pad-icons">
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
          </view>
          <view class="pad-text">4张</view>
        </view>
        <view class="pad-item {{menstrualPadCount >= 5 ? 'active' : ''}}" data-count="5" bindtap="onPadOptionTap">
          <view class="pad-icons">
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <view class="pad-visual"><view class="pad-visual-inner"></view></view>
            <text class="pad-plus">+</text>
          </view>
          <view class="pad-text">5张+</view>
        </view>
      </view>
      <view class="pad-tip">选择今天湿透的卫生巾数量</view>
    </view>

    <view class="form-group">
      <view class="form-label">经血颜色（可选）</view>
      <view class="color-grid">
        <view class="color-item {{menstrualColor === 'bright_red' ? 'active' : ''}}" data-color="bright_red" bindtap="onColorOptionTap">
          <view class="color-dot" style="background:#ff4d4f;"></view>
          <view class="color-text">鲜红</view>
        </view>
        <view class="color-item {{menstrualColor === 'dark_red' ? 'active' : ''}}" data-color="dark_red" bindtap="onColorOptionTap">
          <view class="color-dot" style="background:#a8071a;"></view>
          <view class="color-text">暗红</view>
        </view>
        <view class="color-item {{menstrualColor === 'brown' ? 'active' : ''}}" data-color="brown" bindtap="onColorOptionTap">
          <view class="color-dot" style="background:#8B4513;"></view>
          <view class="color-text">褐色</view>
        </view>
        <view class="color-item {{menstrualColor === 'pink' ? 'active' : ''}}" data-color="pink" bindtap="onColorOptionTap">
          <view class="color-dot" style="background:#ff85c0;"></view>
          <view class="color-text">粉色</view>
        </view>
      </view>
    </view>

    <view class="form-group">
      <view class="form-label">备注</view>
      <textarea class="textarea-input" 
                placeholder="记录经期相关情况" 
                value="{{menstrualNote}}"
                bindinput="onMenstrualNoteInput"
                maxlength="100">
      </textarea>
    </view>

    <view class="button-group" wx:if="{{todayRecord && todayRecord.menstrual}}">
      <button class="delete-button-full" bindtap="deleteRecord" data-type="menstrual">
        删除经量记录
      </button>
    </view>
  </view>

  <!-- 同房记录 -->
  <view class="record-section" wx:if="{{recordType === 'intercourse'}}">
    <view class="section-title">
      <text class="title-text">同房记录</text>
      <text class="title-desc">记录同房情况</text>
    </view>

    <view class="form-group">
      <view class="switch-item no-intercourse">
        <text class="switch-label">今日无同房</text>
        <switch checked="{{noIntercourseToday}}" bindchange="onNoIntercourseChange" color="#4ecdc4"/>
      </view>
    </view>

    <view class="intercourse-form" wx:if="{{!noIntercourseToday}}">
      <view class="form-group">
        <view class="form-label">时间</view>
        <picker mode="time" value="{{intercourseTime}}" bindchange="onIntercourseTimeChange">
          <view class="picker-input {{intercourseTime ? 'has-value' : ''}}">
            <text class="picker-text">{{intercourseTime || '请选择时间'}}</text>
            <text class="picker-arrow">▼</text>
          </view>
        </picker>
      </view>

      <view class="form-group">
        <view class="switch-item">
          <text class="switch-label">采取避孕措施</text>
          <switch checked="{{hasProtection}}" bindchange="onProtectionChange" color="#4ecdc4"/>
        </view>
      </view>

      <view class="form-group">
        <view class="form-label">备注</view>
        <textarea class="textarea-input" 
                  placeholder="记录相关情况" 
                  value="{{intercourseNote}}"
                  bindinput="onIntercourseNoteInput"
                  maxlength="100">
        </textarea>
      </view>
    </view>

    <view class="button-group" wx:if="{{todayRecord && todayRecord.intercourse}}">
      <button class="delete-button-full" bindtap="deleteRecord" data-type="intercourse">
        删除同房记录
      </button>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{isLoading}}">
    <view class="loading-content">
      <text class="loading-text">处理中...</text>
    </view>
  </view>
</view>